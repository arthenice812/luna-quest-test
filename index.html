<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QUEST: –õ—É–Ω–∞ –ø—Ä–æ—Ç–∏–≤ –°–µ—Ä–æ—Å—Ç–∏</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
        
        body { margin: 0; background: #000; color: #fff; font-family: 'Montserrat', sans-serif; overflow: hidden; height: 100vh; }
        #game-container { position: relative; width: 100%; height: 100%; max-width: 500px; margin: 0 auto; background: #111; }
        
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; background: #000; }
        
        /* –ó–∞–≥–ª—É—à–∫–∞ (—Ü–≤–µ—Ç–Ω–æ–π —Ñ–æ–Ω) */
        #fallback-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; font-size: 1.2rem; font-weight: bold; transition: background 0.5s ease; }

        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px 30px; box-sizing: border-box; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent 60%); pointer-events: none; }
        
        /* –ö–ù–û–ü–ö–ò-–í–ï–ù–ö–ò üéÑ */
        button { 
            pointer-events: auto; 
            background: rgba(60, 50, 75, 0.85); 
            color: #fff; 
            border: 3px solid #2d5a27; /* –ó–µ–ª–µ–Ω–∞—è —Ö–≤–æ—è */
            border-radius: 15px;
            padding: 14px; 
            margin: 6px 0; 
            font-weight: bold; 
            font-size: 0.95rem; 
            cursor: pointer; 
            text-transform: uppercase; 
            /* –°–≤–µ—á–µ–Ω–∏–µ –∏–≥—Ä—É—à–µ–∫ */
            box-shadow: 0 0 5px #2d5a27, 0 0 0 1px #c0392b inset;
            width: 100%; 
            position: relative;
            backdrop-filter: blur(5px);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.96); }
        button::before { content: 'üéÑ '; margin-right: 5px; }

        /* –ö–Ω–æ–ø–∫–∞ –ù–ê–ó–ê–î */
        button.back-btn { 
            background: rgba(40, 40, 40, 0.9); 
            border-color: #555; 
            box-shadow: none; 
            font-size: 0.9rem; 
            margin-top: 10px; 
        }
        button.back-btn::before { content: '‚Ü©Ô∏è '; }

        /* –î–ò–ê–õ–û–ì–ò –ò –ü–†–ê–í–ò–õ–ê */
        .modal-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: rgba(20, 15, 30, 0.98); border: 3px solid #ffd700; border-radius: 20px; padding: 30px; z-index: 20; text-align: center; pointer-events: auto; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        .modal-text { font-size: 1.1rem; margin-bottom: 25px; line-height: 1.5; }
        
        .dialog-btns { display: flex; flex-direction: column; gap: 10px; }

        .scroll-popup { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; animation: fadeIn 0.5s; }
        .scroll-content { background: #fff5e6; color: #4a3b2a; padding: 40px 20px; border-radius: 5px; max-width: 80%; text-align: center; box-shadow: 0 0 50px #ffd700; transform: scale(0); animation: scaleIn 0.5s forwards; border: 8px double #8b4513; }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: rgba(10, 5, 20, 0.98); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 30px; box-sizing: border-box; }
        .hidden { display: none !important; }
        input { padding: 15px; border-radius: 10px; border: 2px solid #2d5a27; background: #222; color: #fff; font-size: 1.1rem; margin-bottom: 20px; width: 100%; box-sizing: border-box; text-align: center; }
        
        #inventory { position: absolute; top: 20px; right: 20px; z-index: 15; background: rgba(45, 90, 39, 0.8); padding: 8px 15px; border-radius: 20px; border: 2px solid #ffd700; font-weight: bold; color: #fff; display: none; }

        @keyframes scaleIn { from { transform: scale(0) rotate(-10deg); } to { transform: scale(1) rotate(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="game-container">
    <div id="fallback-screen">–ó–ê–ì–†–£–ó–ö–ê...</div>
    <video id="vid" playsinline webkit-playsinline muted></video>
    <div id="inventory">üìú –°–≤–∏—Ç–æ–∫: <span id="count">0</span>/8</div>
    
    <div id="ui" class="ui-layer hidden"></div>

    <div id="dialog" class="modal-box hidden">
        <div id="dialog-text" class="modal-text"></div>
        <div id="dialog-buttons" class="dialog-btns"></div>
    </div>

    <div id="rulesScreen" class="modal-box hidden" style="z-index: 110;">
        <h2 style="color:#ffd700; margin-top:0;">–ü–†–ê–í–ò–õ–ê –ò–ì–†–´ üéÑ</h2>
        <div class="modal-text" style="text-align: left; font-size: 0.95rem;">
            1. –¢—ã –≤ –æ—Ñ–∏—Å–µ "Open Service".<br>
            2. –¢–≤–æ—è —Ü–µ–ª—å: –Ω–∞–π—Ç–∏ 8 —á–∞—Å—Ç–µ–π –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è.<br>
            3. –ó–∞—Ö–æ–¥–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç—ã –∏ –≥–æ–≤–æ—Ä–∏ —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏.<br>
            4. –°–æ–±–µ—Ä–∏ –≤—Å—ë, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å –Ω–∞ –ö—É—Ö–Ω—é!
        </div>
        <button onclick="startActualGame()">–ü–û–ì–ù–ê–õ–ò! üöÄ</button>
    </div>

    <div id="scrollPopup" class="scroll-popup hidden">
        <div class="scroll-content">
            <h3 style="margin:0; color:#8b4513">‚ú® –°–¢–†–û–ß–ö–ê –ù–ê–ô–î–ï–ù–ê ‚ú®</h3>
            <p style="font-family:'Georgia'; font-style:italic; font-size:1.2rem; font-weight:bold; margin:20px 0;" id="scrollLineText">...</p>
            <button onclick="closeScroll()" style="background:#8b4513; border-color:#5a2d0c; box-shadow:none;">–í –ò–ù–í–ï–ù–¢–ê–†–¨</button>
        </div>
    </div>

    <div id="loginScreen" class="overlay">
        <h1 style="color:#ffd700; text-shadow: 0 0 10px #ff0000;">üéÑ –õ–£–ù–ê v –°–ï–†–û–°–¢–¨ üéÑ</h1>
        <p>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–≤–µ—Å—Ç.<br>–°–æ–±–µ—Ä–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ, —Å–ø–∞—Å–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫.</p>
        <input type="text" id="username" placeholder="–¢–≤–æ–µ –∏–º—è">
        <button onclick="showRules()">–ù–ê–ß–ê–¢–¨</button>
    </div>

    <div id="winScreen" class="overlay hidden">
        <h1 style="color:#ffd700">–ü–û–ë–ï–î–ê!</h1>
        <p>–¢—ã —Å–æ–±—Ä–∞–ª(–∞) –≤—Å—ë –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ!<br>–ù–æ–≤—ã–π –≥–æ–¥ —Å–ø–∞—Å–µ–Ω!</p>
        <button onclick="location.reload()">–í –ú–ï–ù–Æ</button>
    </div>
</div>

<script>
    const TG_TOKEN = "8287827338:AAEaIEkNbJuk_6oFR5lEmLCQ0nObVKvpmsg"; 
    const TG_CHAT_ID = "7524680591";

    const vid = document.getElementById('vid');
    const fallback = document.getElementById('fallback-screen');
    const ui = document.getElementById('ui');
    const dialog = document.getElementById('dialog');
    let collected = new Set();
    let userName = "–ò–≥—Ä–æ–∫";

    const POEM_LINES = {
        1: "–ó–∞–∂–∂—ë–º —Å–µ—Ä–¥—Ü–∞, –ø—Ä–æ–≥–æ–Ω–∏–º –ø—Ä–æ—á—å —Ç–æ—Å–∫—É,",
        2: "–ö–ª–∏–µ–Ω—Ç –¥–æ–≤–æ–ª–µ–Ω ‚Äî –º—ã –≤—Å–µ–≥–¥–∞ –Ω–∞ —á–µ–∫—É!",
        3: "–°–≤–µ–¥—ë–º –±–∞–ª–∞–Ω—Å: –∫–æ–ø–µ–π–∫–∞ –¥–æ —Ä—É–±–ª—è,",
        4: "–ò –Ω–µ –∑–∞–≤–∏—Å–Ω–µ—Ç —Å–µ—Ä–≤–µ—Ä –Ω–∏–∫–æ–≥–¥–∞!",
        5: "–°—Ç—Ä–∞—Ç–µ–≥–∏—è —è—Å–Ω–∞, –±—é–¥–∂–µ—Ç —Ä–∞—Å—Ç—ë—Ç,",
        6: "–ü–æ–±—å—ë–º —Ä–µ–∫–æ—Ä–¥—ã –≤ —ç—Ç–æ—Ç –ù–æ–≤—ã–π –≥–æ–¥!",
        7: "–°–∏—Å—Ç–µ–º–∞ ‚Äî –≤ –Ω–æ—Ä–º–µ, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ ‚Äî –∏–¥–µ–∞–ª,",
        8: "–ß—Ç–æ–± —á–∏—Å—Ç—ã–π –∫–æ–¥ –ø–æ–±–µ–¥—É –Ω–∞–º –∫–æ–≤–∞–ª!"
    };

    // –§–ê–ô–õ–´ –í–ò–î–ï–û (–ó–ê–ì–†–£–ó–ò –ò–• –ò–ú–ï–ù–ù–û –° –¢–ê–ö–ò–ú–ò –ò–ú–ï–ù–ê–ú–ò)
    const S = {
        intro: '00_intro.mp4', lift: '01_lift_open.mp4',
        
        corr_ou: '02_corridor_ou.mp4',
        enter_ou: '03_enter_ou.mp4', ou_in: '04_ou_inside.mp4', exit_ou: '14_exit_ou.mp4',
        
        talk_happy: '05_talk_happy.mp4', talk_client: '06_talk_client.mp4', talk_gen: '07_talk_general.mp4',
        
        enter_it: '08_enter_it.mp4', talk_it: '09_talk_it.mp4', exit_it: '10_exit_it.mp4',
        enter_fd: '11_enter_findir.mp4', talk_fd: '12_talk_findir.mp4', exit_fd: '13_exit_findir.mp4',
        
        walk_sales: '15_walk_to_sales.mp4', corr_sales: '16_corridor_sales.mp4',
        enter_sales: '17_enter_sales.mp4', sales_in: '18_sales_inside.mp4', talk_sales: '19_talk_sales.mp4', exit_sales: '20_exit_sales.mp4',

        walk_getit: '21_walk_to_getit.mp4', corr_getit: '22_corridor_getit.mp4',
        enter_getit: '23_enter_getit.mp4', getit_in: '24_getit_inside.mp4', talk_getit: '25_talk_getit.mp4', exit_getit: '26_exit_getit.mp4',

        walk_vnedr: '27_walk_to_vnedr.mp4', corr_vnedr: '28_corridor_vnedr.mp4',
        enter_vnedr: '29_enter_vnedr.mp4', vnedr_in: '30_vnedr_inside.mp4', talk_vnedr: '31_talk_vnedr.mp4', exit_vnedr: '32_exit_vnedr.mp4',

        walk_kitch: '33_walk_to_kitchen.mp4', corr_kitch: '34_corridor_kitchen.mp4',
        kitch_lock: '35_kitchen_locked.mp4', kitch_open: '36_kitchen_open.mp4', party: '37_party_loop.mp4', final: '38_final.mp4'
    };
    
    // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∞
    const V_LOOP = "https://media.istockphoto.com/id/1363653139/video/abstract-background.mp4?s=mp4-640x640-is&k=20&c=6a_aQjQGkY3XFjF9p0yqQ1qXqQ4Q4Q4Q4Q4Q4Q4Q4Q=";
    const V_WIN = "https://media.istockphoto.com/id/1183318283/video/fireworks.mp4?s=mp4-640x640-is&k=20&c=6a_aQjQGkY3XFjF9p0yqQ1qXqQ4Q4Q4Q4Q4Q4Q4Q4Q=";

    const scenes = {
        'intro': { file: S.intro, loop: true, color: '#111' },
        'lift': { file: S.lift, next: 'c1', color: '#222' },

        // --- –≠–¢–ê–ü 1: –û–£ ---
        'c1': { file: S.corr_ou, loop: true, color: '#2c3e50', btns: [
            {t: 'üìÇ –ó–∞–π—Ç–∏ –≤ –û—Ç–¥–µ–ª –£—á–µ—Ç–∞', go: 'enter_ou'},
            {t: '–ò–¥—Ç–∏ –¥–∞–ª—å—à–µ ‚û°Ô∏è', go: 'w_sales', class: 'back-btn'}
        ]},
        'enter_ou': { file: S.enter_ou, next: 'ou_hub', color: '#c0392b' },
        'ou_hub': { file: S.ou_in, loop: true, color: '#c0392b', btns: [
            {t: '‚ú® –ü–æ–¥–æ–π—Ç–∏ –∫ "–°—á–∞—Å—Ç—å—é"', act: 'happy'},
            {t: 'üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –£—á–µ—Ç–∞', go: 'ou_sub'},
            {t: 'üíª –ó–∞–π—Ç–∏ –≤ IT', go: 'enter_it'},
            {t: 'üíº –ó–∞–π—Ç–∏ –∫ –§–∏–Ω–î–∏—Ä—É', go: 'enter_fd'},
            {t: '–í—ã–π—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä ‚Ü©Ô∏è', go: 'exit_ou', class: 'back-btn'}
        ]},
        // –ü–û–î–ú–ï–ù–Æ –û–£
        'ou_sub': { file: S.ou_in, loop: true, color: '#a93226', btns: [
            {t: 'üìÑ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —É—á–µ—Ç', act: 'gen'},
            {t: 'ü§ù –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –æ—Ç–¥–µ–ª', act: 'client'},
            {t: '–ù–∞–∑–∞–¥ –≤ —Ü–µ–Ω—Ç—Ä –û–£ ‚Ü©Ô∏è', go: 'ou_hub', class: 'back-btn'}
        ]},
        // –î–ò–ê–õ–û–ì–ò –û–£
        'talk_happy': { vid: S.talk_happy, id: 1, color: '#e74c3c' },
        'talk_client': { vid: S.talk_client, id: 2, color: '#e74c3c' },
        'talk_gen': { vid: S.talk_gen, id: 3, color: '#e74c3c' },
        // IT
        'enter_it': { file: S.enter_it, loop: true, color: '#27ae60', btns: [{t: 'üíª –ì–æ–≤–æ—Ä–∏—Ç—å —Å IT', act: 'it'}, {t: '–ù–∞–∑–∞–¥ –≤ –û–£', go: 'exit_it', class: 'back-btn'}] },
        'talk_it': { vid: S.talk_it, id: 4, exit: 'exit_it', color: '#2ecc71' },
        'exit_it': { file: S.exit_it, next: 'ou_hub', color: '#27ae60' },
        // FD
        'enter_fd': { file: S.enter_fd, loop: true, color: '#8e44ad', btns: [{t: 'üíº –ì–æ–≤–æ—Ä–∏—Ç—å —Å –§–∏–Ω–î–∏—Ä–æ–º', act: 'fd'}, {t: '–ù–∞–∑–∞–¥ –≤ –û–£', go: 'exit_fd', class: 'back-btn'}] },
        'talk_fd': { vid: S.talk_fd, id: 5, exit: 'exit_fd', color: '#9b59b6' },
        'exit_fd': { file: S.exit_fd, next: 'ou_hub', color: '#8e44ad' },
        // –í–´–•–û–î –ò–ó –û–£
        'exit_ou': { file: S.exit_ou, next: 'c1', color: '#333' },

        // --- –≠–¢–ê–ü 2: –ü–†–û–î–ê–ñ–ò ---
        'w_sales': { file: S.walk_sales, next: 'c2', color: '#444' },
        'c2': { file: S.corr_sales, loop: true, color: '#d35400', btns: [{t: 'üìà –ó–∞–π—Ç–∏ –≤ –ü—Ä–æ–¥–∞–∂–∏', go: 'enter_sales'}, {t: '–ò–¥—Ç–∏ –¥–∞–ª—å—à–µ ‚û°Ô∏è', go: 'w_getit', class: 'back-btn'}, {t: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –û–£', go: 'c1', class: 'back-btn'}] },
        'enter_sales': { file: S.enter_sales, next: 'sales_in', color: '#e67e22' },
        'sales_in': { file: S.sales_in, loop: true, color: '#e67e22', btns: [{t: 'üó£ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å', act: 'sales'}, {t: '–í—ã–π—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä', go: 'exit_sales', class: 'back-btn'}] },
        'talk_sales': { vid: S.talk_sales, id: 6, exit: 'sales_in', color: '#f39c12' },
        'exit_sales': { file: S.exit_sales, next: 'c2', color: '#d35400' },

        // --- –≠–¢–ê–ü 3: GET IT ---
        'w_getit': { file: S.walk_getit, next: 'c3', color: '#444' },
        'c3': { file: S.corr_getit, loop: true, color: '#2980b9', btns: [{t: 'üíª –ó–∞–π—Ç–∏ –≤ Get IT', go: 'enter_getit'}, {t: '–ò–¥—Ç–∏ –¥–∞–ª—å—à–µ ‚û°Ô∏è', go: 'w_vnedr', class: 'back-btn'}, {t: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –ü—Ä–æ–¥–∞–∂–∞–º', go: 'c2', class: 'back-btn'}] },
        'enter_getit': { file: S.enter_getit, next: 'getit_in', color: '#3498db' },
        'getit_in': { file: S.getit_in, loop: true, color: '#3498db', btns: [{t: 'üë®‚Äçüíª –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å', act: 'getit'}, {t: '–í—ã–π—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä', go: 'exit_getit', class: 'back-btn'}] },
        'talk_getit': { vid: S.talk_getit, id: 8, exit: 'getit_in', color: '#5dade2' },
        'exit_getit': { file: S.exit_getit, next: 'c3', color: '#2980b9' },

        // --- –≠–¢–ê–ü 4: –í–ù–ï–î–†–ï–ù–ò–ï ---
        'w_vnedr': { file: S.walk_vnedr, next: 'c4', color: '#444' },
        'c4': { file: S.corr_vnedr, loop: true, color: '#7f8c8d', btns: [{t: 'üì¶ –ó–∞–π—Ç–∏ –≤–æ –í–Ω–µ–¥—Ä–µ–Ω–∏–µ', go: 'enter_vnedr'}, {t: '–ò–¥—Ç–∏ –Ω–∞ –ö—É—Ö–Ω—é ‚û°Ô∏è', go: 'w_kitch', class: 'back-btn'}, {t: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ Get IT', go: 'c3', class: 'back-btn'}] },
        'enter_vnedr': { file: S.enter_vnedr, next: 'vnedr_in', color: '#95a5a6' },
        'vnedr_in': { file: S.vnedr_in, loop: true, color: '#95a5a6', btns: [{t: 'üì¶ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å', act: 'vnedr'}, {t: '–í—ã–π—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä', go: 'exit_vnedr', class: 'back-btn'}] },
        'talk_vnedr': { vid: S.talk_vnedr, id: 7, exit: 'vnedr_in', color: '#bdc3c7' },
        'exit_vnedr': { file: S.exit_vnedr, next: 'c4', color: '#7f8c8d' },

        // --- –≠–¢–ê–ü 5: –ö–£–•–ù–Ø ---
        'w_kitch': { file: S.walk_kitch, next: 'c5', color: '#444' },
        'c5': { file: S.corr_kitch, loop: true, color: '#8e44ad', btns: [{t: 'üçΩÔ∏è –ó–∞–π—Ç–∏ –Ω–∞ –ö—É—Ö–Ω—é', act: 'kitchen'}, {t: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –í–Ω–µ–¥—Ä–µ–Ω–∏—é', go: 'c4', class: 'back-btn'}] },
        'kitch_lock': { file: S.kitch_lock, next: 'c5', color: '#000', alert: true },
        'kitch_open': { file: S.kitch_open, next: 'party', color: '#ff00ff' },
        'party': { file: S.party, loop: true, color: '#ff00ff', btns: [{t: '‚ú® –ü–†–û–ß–ò–¢–ê–¢–¨ –ó–ê–ö–õ–ò–ù–ê–ù–ò–ï ‚ú®', go: 'final'}] },
        'final': { file: S.final, win: true, color: '#ffd700' }
    };

    function showRules() {
        const input = document.getElementById('username');
        if (!input.value) { alert("–í–≤–µ–¥–∏ –∏–º—è!"); return; }
        userName = input.value;
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('rulesScreen').classList.remove('hidden');
    }

    function startActualGame() {
        sendTg(`üöÄ <b>${userName}</b> –Ω–∞—á–∞–ª(–∞) –∏–≥—Ä—É!`);
        document.getElementById('rulesScreen').classList.add('hidden');
        document.getElementById('inventory').style.display = 'block';
        playScene('intro');
        // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ª–∏—Ñ—Ç–æ–º (–¥–ª—è –ø—Ä–æ–ª–æ–≥–∞)
        setTimeout(() => playScene('lift'), 4000); 
    }

    function playScene(key) {
        const s = scenes[key];
        ui.innerHTML = '';
        dialog.classList.add('hidden');
        fallback.style.background = s.color || '#333';
        fallback.innerHTML = "–°–¶–ï–ù–ê: " + key.toUpperCase();
        
        // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —É–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ includes('http') –µ—Å–ª–∏ –≤—Å–µ —Ñ–∞–π–ª—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ
        let src = s.file;
        if (!src.includes('mp4')) src = V_LOOP; // –ó–∞—â–∏—Ç–∞
        
        vid.src = src.includes('http') ? src : src; 
        if (!s.file.includes('http')) vid.src = s.win ? V_WIN : V_LOOP; // –¢–ï–°–¢ –†–ï–ñ–ò–ú

        vid.loop = s.loop || false;
        vid.play().catch(() => { if(!s.loop) setTimeout(() => onVideoEnd(s), 1500); else showBtns(s); });
        
        vid.onended = () => onVideoEnd(s);
        if (s.alert) { alert("–ù—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–æ—á–∫–∏!"); playScene(s.next); }
    }

    function onVideoEnd(s) {
        if (s.next) playScene(s.next);
        if (s.win) showWin();
        if (s.btns) showBtns(s);
    }

    function showBtns(s) {
        ui.innerHTML = '';
        ui.classList.remove('hidden');
        s.btns.forEach(b => {
            const btn = document.createElement('button');
            btn.innerText = b.t;
            if (b.class) btn.classList.add(b.class);
            btn.onclick = () => {
                if (b.go) playScene(b.go);
                if (b.act === 'kitchen') tryKitchen();
                else if (b.act) startDialog(b.act);
            };
            ui.appendChild(btn);
        });
    }

    // –î–ò–ê–õ–û–ì–ò
    const ACTS = {
        'happy': {vid: 'talk_happy'}, 'client': {vid: 'talk_client'}, 'gen': {vid: 'talk_gen'},
        'it': {vid: 'talk_it'}, 'fd': {vid: 'talk_fd'}, 'sales': {vid: 'talk_sales'},
        'getit': {vid: 'talk_getit'}, 'vnedr': {vid: 'talk_vnedr'}
    };

    function startDialog(act) {
        const key = ACTS[act].vid;
        const s = scenes[key];
        ui.classList.add('hidden');
        dialog.classList.remove('hidden');
        document.getElementById('dialog-text').innerText = "–ü—Ä–∏–≤–µ—Ç! –£ –º–µ–Ω—è –µ—Å—Ç—å —Å—Ç—Ä–æ—á–∫–∞. –î–µ—Ä–∂–∏!";
        const dBtns = document.getElementById('dialog-buttons');
        dBtns.innerHTML = '';
        
        const b1 = document.createElement('button');
        b1.innerText = "–í–∑—è—Ç—å";
        if (collected.has(s.id)) { b1.innerText = "–£–∂–µ –µ—Å—Ç—å"; b1.disabled = true; b1.style.opacity = 0.5; }
        else b1.onclick = () => playItemVid(s);
        
        const b2 = document.createElement('button');
        b2.innerText = "–ù–∞–∑–∞–¥"; b2.className = 'back-btn';
        // –í–æ–∑–≤—Ä–∞—Ç: –µ—Å–ª–∏ —ç—Ç–æ –¥–∏–∞–ª–æ–≥ IT/FD/Sales - —É –Ω–∏—Ö –µ—Å—Ç—å exit video. 
        // –ï—Å–ª–∏ —ç—Ç–æ Happiness/Client/Gen - –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ–Ω—é (ou_hub/ou_sub).
        b2.onclick = () => { 
            dialog.classList.add('hidden'); 
            if (s.exit) playScene(s.exit); // –ï—Å—Ç—å –≤–∏–¥–µ–æ –≤—ã—Ö–æ–¥–∞
            else playScene('ou_hub'); // –ù–µ—Ç –≤–∏–¥–µ–æ –≤—ã—Ö–æ–¥–∞ (–¥–ª—è —Å—Ç–æ–ª–æ–≤ –û–£)
        };
        
        dBtns.append(b1, b2);
    }

    function playItemVid(s) {
        dialog.classList.add('hidden');
        fallback.innerHTML = "–í–ò–î–ï–û –î–ò–ê–õ–û–ì";
        vid.src = V_LOOP; vid.loop = false; vid.play(); // –¢–ï–°–¢
        vid.onended = () => showScroll(s.id, s.exit);
    }

    function showScroll(id, exitKey) {
        document.getElementById('scrollPopup').classList.remove('hidden');
        document.getElementById('scrollLineText').innerText = POEM_LINES[id];
        // –ï—Å–ª–∏ exitKey –Ω–µ—Ç (–¥–ª—è —Å—Ç–æ–ª–æ–≤ –û–£), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —Ö–∞–±
        window.nextKey = exitKey || 'ou_hub';
        if (!collected.has(id)) {
            collected.add(id);
            document.getElementById('count').innerText = collected.size;
            sendTg(`üìú ${userName} –Ω–∞—à–µ–ª —Å—Ç—Ä–æ—á–∫—É #${id}`);
        }
    }

    function closeScroll() {
        document.getElementById('scrollPopup').classList.add('hidden');
        playScene(window.nextKey);
    }

    function tryKitchen() {
        if (collected.size >= 8) playScene('kitch_open');
        else playScene('kitch_lock');
    }

    function showWin() {
        document.getElementById('winScreen').classList.remove('hidden');
        sendTg(`üèÜ ${userName} –ü–†–û–®–ï–õ –ò–ì–†–£!`);
    }

    function sendTg(text) {
        fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({chat_id: TG_CHAT_ID, text: text, parse_mode: 'HTML'})
        }).catch(e=>console.log(e));
    }
</script>
</body>
</html>
