<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>QUEST: –õ—É–Ω–∞ vs –°–µ—Ä–æ—Å—Ç—å</title>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap");
    :root{ --gold:#ffd700; --green:#2d5a27; --bg:#000; }

    body{ margin:0; background:var(--bg); color:#fff; font-family:"Montserrat",sans-serif; overflow:hidden; height:100vh; }
    #game-container{ position:relative; width:100%; height:100%; max-width:500px; margin:0 auto; background:#111; }
    video{ width:100%; height:100%; object-fit:contain; position:absolute; inset:0; z-index:1; background:#000; }

    #fallback-screen{
      position:absolute; inset:0; z-index:0; display:flex; align-items:center; justify-content:center;
      text-align:center; padding:20px; font-size:1.05rem; font-weight:700; white-space:pre-line; opacity:.92;
    }

    .ui-layer{
      position:absolute; inset:0; z-index:10;
      display:flex; flex-direction:column; justify-content:flex-end;
      padding:20px 30px; box-sizing:border-box;
      background:linear-gradient(to top, rgba(0,0,0,.9), transparent 60%);
      pointer-events:none;
    }

    button{
      pointer-events:auto; background:rgba(60,50,75,.9); color:#fff; border:3px solid var(--green); border-radius:15px;
      padding:14px; margin:6px 0; font-weight:700; font-size:.95rem; cursor:pointer; text-transform:uppercase;
      box-shadow:0 0 5px var(--green), 0 0 0 1px #c0392b inset; width:100%; backdrop-filter:blur(5px);
      transition:transform .1s, opacity .2s;
    }
    button:active{ transform:scale(.96); }
    button::before{ content:"üéÑ "; margin-right:5px; }

    button.back-btn{
      background:rgba(40,40,40,.9); border-color:#555; box-shadow:none; font-size:.9rem; margin-top:10px; text-transform:none;
    }
    button.back-btn::before{ content:"‚Ü©Ô∏è "; }

    button.alt-btn{
      background:rgba(0,0,0,.55); border-color:var(--gold); box-shadow:0 0 10px rgba(255,215,0,.2); text-transform:none;
    }
    button.alt-btn::before{ content:"‚ú® "; }

    .overlay{
      position:absolute; inset:0; z-index:100; background:rgba(10,5,20,.92);
      display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;
      padding:30px; box-sizing:border-box;
    }
    .hidden{ display:none !important; }

    input{
      padding:15px; border-radius:10px; border:2px solid var(--green); background:#222; color:#fff; font-size:1.05rem;
      margin:12px 0 18px; width:100%; box-sizing:border-box; text-align:center;
    }

    #inventory{
      position:absolute; top:18px; right:18px; z-index:15;
      background:rgba(45,90,39,.8); padding:8px 14px; border-radius:20px; border:2px solid var(--gold);
      font-weight:700; color:#fff; display:none; box-shadow:0 0 12px rgba(0,0,0,.35);
    }

    /* POPUP —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π (—Å—Ç—Ä–æ—á–∫–∞/—Å–≤–∏—Ç–æ–∫) */
    #imgPopup{
      position:absolute; inset:0; z-index:60;
      background:rgba(0,0,0,.92);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    #imgPopup.hidden{ display:none !important; }
    .imgCard{ position:relative; max-width:96%; max-height:92%; display:flex; align-items:center; justify-content:center; }
    .imgCard img{
      max-width:100%; max-height:88vh; height:auto; width:auto;
      border-radius:14px; border:3px solid var(--gold);
      box-shadow:0 0 40px rgba(0,0,0,.7);
      background:rgba(255,255,255,.02);
    }
    .closeX{
      position:absolute; top:-14px; right:-14px; width:42px; height:42px; border-radius:50%;
      border:2px solid rgba(255,215,0,.9); background:rgba(0,0,0,.7); color:#fff; font-weight:800; cursor:pointer;
      display:flex; align-items:center; justify-content:center; box-shadow:0 0 18px rgba(255,215,0,.25);
      pointer-events:auto; user-select:none;
    }
    .closeX:active{ transform:scale(.96); }

    /* RULES */
    #rulesModal{
      width:100%; max-width:440px; background:rgba(20,15,30,.96);
      border:3px solid var(--gold); border-radius:20px; padding:22px;
      box-shadow:0 0 30px rgba(0,0,0,.75); text-align:left;
    }
    #rulesModal h2{ margin:0 0 10px; color:var(--gold); text-align:center; }
    #rulesModal .txt{ font-size:.95rem; line-height:1.35; color:#fff; }
    #rulesModal ul{ margin:10px 0 0 18px; padding:0; }
    #rulesModal li{ margin:7px 0; }

    /* PUZZLE */
    #puzzleScreen{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      width:90%; background:rgba(20,15,30,.98); border:3px solid var(--gold);
      border-radius:20px; padding:22px; z-index:120; text-align:center; box-shadow:0 0 30px rgba(0,0,0,.8);
    }
    #puzzleScreen .modal-text{ text-align:left; font-size:.95rem; color:#fff; }
    .pill{
      display:inline-block; padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.08); margin:6px 6px 0 0; cursor:pointer; user-select:none; font-size:.9rem; line-height:1.2;
    }
    .pill:hover{ background:rgba(255,255,255,.14); }
    .pill.used{ opacity:.35; pointer-events:none; text-decoration:line-through; }
    .orderBox{
      margin-top:12px; padding:12px; border-radius:14px; border:2px dashed rgba(255,215,0,.7);
      background:rgba(0,0,0,.25); min-height:64px; text-align:left; font-size:.95rem;
    }
    .orderLine{
      margin:6px 0; padding:10px 10px; border-radius:12px; background:rgba(255,215,0,.12);
      border:1px solid rgba(255,215,0,.25);
    }
  </style>
</head>

<body>
<div id="game-container">
  <div id="fallback-screen"></div>
  <video id="vid" playsinline webkit-playsinline muted></video>

  <div id="inventory">üìú –°–≤–∏—Ç–æ–∫: <span id="count">0</span>/8</div>
  <div id="ui" class="ui-layer hidden"></div>

  <!-- POPUP -->
  <div id="imgPopup" class="hidden">
    <div class="imgCard">
      <div class="closeX" id="imgPopupClose">‚úï</div>
      <img id="imgPopupImg" src="" alt="popup image" />
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginScreen" class="overlay">
    <h1 style="color:var(--gold);text-shadow:0 0 10px #ff0000;margin:0 0 10px;">üéÑ –õ–£–ù–ê vs –°–ï–†–û–°–¢–¨ üéÑ</h1>
    <p style="margin:0 0 12px;">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–≤–µ—Å—Ç.<br/>–°–æ–±–µ—Ä–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ, —Å–ø–∞—Å–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫.</p>

    <div id="continueBox" class="hidden" style="width:100%;max-width:420px;background:rgba(20,15,30,.96);border:3px solid var(--gold);border-radius:20px;padding:20px;">
      <div style="text-align:center;margin-bottom:12px;">
        –ù–∞–π–¥–µ–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è <b id="savedName">–ò–≥—Ä–æ–∫</b>.<br/>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?
      </div>
      <button onclick="continueGame()" class="alt-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      <button onclick="resetProgress()" class="back-btn">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    </div>

    <div id="newGameBox" style="width:100%;max-width:420px;">
      <input type="text" id="username" placeholder="–¢–≤–æ—ë –∏–º—è" />
      <button onclick="startGame()">–ù–ê–ß–ê–¢–¨</button>
    </div>
  </div>

  <!-- RULES -->
  <div id="rulesScreen" class="overlay hidden">
    <div id="rulesModal">
      <h2>–ü–†–ê–í–ò–õ–ê –ò–ì–†–´ üéÑ</h2>
      <div class="txt">
        –¢–≤–æ—è —Ü–µ–ª—å ‚Äî —Å–æ–±—Ä–∞—Ç—å <b>8 —á–∞—Å—Ç–µ–π –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è</b> –∏ —Å–ø–∞—Å—Ç–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫.
        <ul>
          <li>–ò–¥–∏ –ø–æ –∫–æ—Ä–∏–¥–æ—Ä—É –∏ –∑–∞—Ö–æ–¥–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç—ã.</li>
          <li>–í–Ω—É—Ç—Ä–∏ –Ω–∞–∂–∏–º–∞–π <b>¬´–ü–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è¬ª</b>, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–æ–∫—É.</li>
          <li>–°—Ç—Ä–æ–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–∞—Ä—Ç–∏–Ω–∫–æ–π (–∑–∞–∫—Ä—ã—Ç—å –∫—Ä–µ—Å—Ç–∏–∫–æ–º).</li>
          <li>–°–æ–±–µ—Ä—ë—à—å 8 ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ö—É—Ö–Ω—è –∏ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–ª–Ω—ã–π —Å–≤–∏—Ç–æ–∫.</li>
        </ul>
      </div>
      <button onclick="startActualGame()" class="alt-btn" style="margin-top:14px;">–ü–û–ì–ù–ê–õ–ò! üöÄ</button>
      <button onclick="backToLogin()" class="back-btn">–ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <!-- PUZZLE -->
  <div id="puzzleScreen" class="hidden">
    <h2 style="color:var(--gold);margin:0 0 10px;">‚ú® –°–û–ë–ï–†–ò –ó–ê–ö–õ–ò–ù–ê–ù–ò–ï ‚ú®</h2>
    <div class="modal-text">–ù–∞–∂–∏–º–∞–π –Ω–∞ —Å—Ç—Ä–æ–∫–∏ (–æ–Ω–∏ –ø–µ—Ä–µ–º–µ—à–∞–Ω—ã), —á—Ç–æ–±—ã –≤—ã—Å—Ç—Ä–æ–∏—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.</div>
    <div id="puzzlePills"></div>
    <div class="orderBox" id="puzzleOrder"></div>
    <div style="display:flex;gap:10px;margin-top:12px;">
      <button onclick="puzzleReset()" class="back-btn" style="margin:0;flex:1;">–°–ë–†–û–°</button>
      <button onclick="puzzleCheck()" class="alt-btn" style="margin:0;flex:1;">–ü–†–û–í–ï–†–ò–¢–¨</button>
    </div>
    <button onclick="closePuzzle()" class="back-btn">–ù–∞–∑–∞–¥</button>
    <div id="puzzleHint" style="margin-top:10px;color:#aaa;font-size:.9rem;"></div>
  </div>

  <!-- WIN -->
  <div id="winScreen" class="overlay hidden">
    <h1 style="color:var(--gold);margin:0 0 10px;">–ü–û–ë–ï–î–ê!</h1>
    <p style="margin:0 0 16px;">–¢—ã —Å–æ–±—Ä–∞–ª(–∞) –≤—Å—ë –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ!<br/>–ù–æ–≤—ã–π –≥–æ–¥ —Å–ø–∞—Å—ë–Ω!</p>
    <button onclick="resetProgress()">–í –ú–ï–ù–Æ</button>
  </div>

  <!-- MUSIC -->
  <audio id="bgm" src="./audio/bgm.mp3" loop preload="auto"></audio>
</div>

<script>
  /******** TELEGRAM ********/
  const TELEGRAM_ENABLED = true;
  const TG_TOKEN = "8287827338:AAEaIEkNbJuk_6oFR5lEmLCQ0nObVKvpmsg";
  const TG_CHAT_ID = "7524680591";
  function sendTg(text){
    if(!TELEGRAM_ENABLED) return;
    fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ chat_id:TG_CHAT_ID, text, parse_mode:"HTML" })
    }).catch(()=>{});
  }

  /******** CORE ********/
  const TOTAL_LINES = 8;
  const STORAGE_KEY = "quest_state_v9_min_changes";

  const VIDEO_BASE = "./videos/";
  const ASSETS_BASE = "./assets/";

  const LOOP_ONLY_FILE = "04_ou_hub_loop.mp4"; // –ª—É–ø —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç

  const VOICE_VIDEOS = new Set([
    "06_ou_happy_give.mp4",
    "08_ou_client_give.mp4",
    "10_ou_internal_give.mp4",
    "12_ou_getit_give.mp4",
    "15_it_give.mp4",
    "23_sales_give.mp4",
    "30_getit_give.mp4",
    "37_vnedr_give.mp4",
    "44_final.mp4"
  ]);

  const vid = document.getElementById("vid");
  const fallback = document.getElementById("fallback-screen");
  const ui = document.getElementById("ui");

  const imgPopup = document.getElementById("imgPopup");
  const imgPopupImg = document.getElementById("imgPopupImg");
  const imgPopupClose = document.getElementById("imgPopupClose");

  const bgm = document.getElementById("bgm");
  const MUSIC_VOL = 0.20; // 40% –∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∞

  let collected = new Set();
  let userName = "–ò–≥—Ä–æ–∫";
  let currentSceneKey = "attract";
  let puzzleSolved = false;

  const LINE_IMG = {
    1: ASSETS_BASE + "line_01.png",
    2: ASSETS_BASE + "line_02.png",
    3: ASSETS_BASE + "line_03.png",
    4: ASSETS_BASE + "line_04.png",
    5: ASSETS_BASE + "line_05.png",
    6: ASSETS_BASE + "line_06.png",
    7: ASSETS_BASE + "line_07.png",
    8: ASSETS_BASE + "line_08.png"
  };
  const FULL_SCROLL_IMG = ASSETS_BASE + "scroll_full.png";

  const POEM_LINES = {
    1: "–ó–∞–∂–∂—ë–º —Å–µ—Ä–¥—Ü–∞, –ø—Ä–æ–≥–æ–Ω–∏–º –ø—Ä–æ—á—å —Ç–æ—Å–∫—É,",
    2: "–ö–ª–∏–µ–Ω—Ç –¥–æ–≤–æ–ª–µ–Ω ‚Äî –º—ã –≤—Å–µ–≥–¥–∞ –Ω–∞ —á–µ–∫—É!",
    3: "–°–≤–µ–¥—ë–º –±–∞–ª–∞–Ω—Å: –∫–æ–ø–µ–π–∫–∞ –¥–æ —Ä—É–±–ª—è,",
    4: "–ò –Ω–µ –∑–∞–≤–∏—Å–Ω–µ—Ç —Å–µ—Ä–≤–µ—Ä –Ω–∏–∫–æ–≥–¥–∞!",
    5: "–°—Ç—Ä–∞—Ç–µ–≥–∏—è —è—Å–Ω–∞, –±—é–¥–∂–µ—Ç —Ä–∞—Å—Ç—ë—Ç,",
    6: "–ü–æ–±—å—ë–º —Ä–µ–∫–æ—Ä–¥—ã –≤ —ç—Ç–æ—Ç –ù–æ–≤—ã–π –≥–æ–¥!",
    7: "–°–∏—Å—Ç–µ–º–∞ ‚Äî –≤ –Ω–æ—Ä–º–µ, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ ‚Äî –∏–¥–µ–∞–ª,",
    8: "–ß—Ç–æ–± —á–∏—Å—Ç—ã–π –∫–æ–¥ –ø–æ–±–µ–¥—É –Ω–∞–º –∫–æ–≤–∞–ª!"
  };

  const LINE_ID = {
    ou_happy: 1,
    ou_client: 2,
    ou_internal: 3,
    it: 4,
    ou_getit: 5,
    sales: 6,
    vnedr: 7,
    getit: 8
  };

  const S = {
    intro: "00_intro.mp4",
    lift: "01_lift_lobby_leftdoor.mp4",
    corr_ou: "02_corridor_ou_loop.mp4",
    enter_ou: "03_enter_ou.mp4",
    ou_hub: "04_ou_hub_loop.mp4",

    ou_happy_hello: "05_ou_happy_hello.mp4",
    ou_happy_give:  "06_ou_happy_give.mp4",

    ou_client_hello:"07_ou_client_hello.mp4",
    ou_client_give: "08_ou_client_give.mp4",

    ou_internal_hello:"09_ou_internal_hello.mp4",
    ou_internal_give: "10_ou_internal_give.mp4",

    ou_getit_hello:"11_ou_getit_hello.mp4",
    ou_getit_give: "12_ou_getit_give.mp4",

    enter_it: "13_enter_it.mp4",
    it_hello: "14_it_hello.mp4",
    it_give:  "15_it_give.mp4",
    exit_it:  "16_exit_it.mp4",

    exit_ou: "17_exit_ou.mp4",

    walk_sales: "18_walk_to_sales.mp4",
    corr_sales: "19_corridor_sales_loop.mp4",
    enter_sales:"20_enter_sales.mp4",
    sales_in:   "21_sales_inside_loop.mp4",
    sales_hello:"22_sales_hello.mp4",
    sales_give: "23_sales_give.mp4",
    exit_sales: "24_exit_sales.mp4",

    walk_getit: "25_walk_to_getit.mp4",
    corr_getit: "26_corridor_getit_loop.mp4",
    enter_getit:"27_enter_getit.mp4",
    getit_in:   "28_getit_inside_loop.mp4",
    getit_hello:"29_getit_hello.mp4",
    getit_give: "30_getit_give.mp4",
    exit_getit: "31_exit_getit.mp4",

    walk_vnedr: "32_walk_to_vnedr.mp4",
    corr_vnedr: "33_corridor_vnedr_loop.mp4",
    enter_vnedr:"34_enter_vnedr.mp4",
    vnedr_in:   "35_vnedr_stock_loop.mp4",
    vnedr_hello:"36_vnedr_hello.mp4",
    vnedr_give: "37_vnedr_give.mp4",
    exit_vnedr: "38_exit_vnedr.mp4",

    walk_kitch: "39_walk_to_kitchen.mp4",
    corr_kitch: "40_corridor_kitchen_loop.mp4",
    kitch_lock: "41_kitchen_locked.mp4",
    kitch_open: "42_kitchen_open.mp4",
    party:      "43_party_loop.mp4",
    final:      "44_final.mp4"
  };

  const scenes = {
    lift:  { file:S.lift, next:"c1", color:"#222" },

    c1: { file:S.corr_ou, color:"#2c3e50",
      btns:[
        { t:"üìÇ –ó–∞–π—Ç–∏ –≤ –û—Ç–¥–µ–ª –£—á—ë—Ç–∞", go:"enter_ou" },
        { t:"–ò–¥—Ç–∏ –¥–∞–ª—å—à–µ ‚û°Ô∏è", go:"w_sales", class:"back-btn" }
      ]
    },

    enter_ou: { file:S.enter_ou, next:"ou_hub", color:"#c0392b" },

    ou_hub: { file:S.ou_hub, color:"#c0392b",
      btns:[
        { t:"üßæ –ü–æ–¥–æ–π—Ç–∏ –∫ –û—Ç–¥–µ–ª—É —É—á—ë—Ç–∞", go:"ou_account" },
        { t:"‚ú® –ü–æ–¥–æ–π—Ç–∏ –∫ –ß–∞—Å—Ç–∏—á–∫–µ —Å—á–∞—Å—Ç—å—è", go:"ou_happy_hello" },
        { t:"üíª –ü–æ–π—Ç–∏ –≤ IT", go:"enter_it" },
        { t:"–í—ã–π—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä ‚Ü©Ô∏è", go:"exit_ou", class:"back-btn" }
      ]
    },

    ou_account: { file:S.ou_hub, color:"#a93226",
      btns:[
        { t:"ü§ù –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —É—á—ë—Ç", go:"ou_client_hello" },
        { t:"üìÑ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —É—á—ë—Ç", go:"ou_internal_hello" },
        { t:"üßæ –£—á—ë—Ç Get IT", go:"ou_getit_hello" },
        { t:"–ù–∞–∑–∞–¥ ‚Ü©Ô∏è", go:"ou_hub", class:"back-btn" }
      ]
    },

    ou_happy_hello: { file:S.ou_happy_hello, color:"#e74c3c",
      hello:{ lineKey:"ou_happy", give:"ou_happy_give", back:"ou_hub" }
    },
    ou_happy_give: { file:S.ou_happy_give, color:"#e74c3c",
      give:{ lineKey:"ou_happy", after:"ou_hub" }
    },

    ou_client_hello: { file:S.ou_client_hello, color:"#e74c3c",
      hello:{ lineKey:"ou_client", give:"ou_client_give", back:"ou_account" }
    },
    ou_client_give: { file:S.ou_client_give, color:"#e74c3c",
      give:{ lineKey:"ou_client", after:"ou_account" }
    },

    ou_internal_hello: { file:S.ou_internal_hello, color:"#e74c3c",
      hello:{ lineKey:"ou_internal", give:"ou_internal_give", back:"ou_account" }
    },
    ou_internal_give: { file:S.ou_internal_give, color:"#e74c3c",
      give:{ lineKey:"ou_internal", after:"ou_account" }
    },

    ou_getit_hello: { file:S.ou_getit_hello, color:"#e74c3c",
      hello:{ lineKey:"ou_getit", give:"ou_getit_give", back:"ou_account" }
    },
    ou_getit_give: { file:S.ou_getit_give, color:"#e74c3c",
      give:{ lineKey:"ou_getit", after:"ou_account" }
    },

    enter_it: { file:S.enter_it, next:"it_room", color:"#27ae60" },

    it_room: { file:S.it_hello, color:"#27ae60",
      btns:[
        { t:"üëã –ü–æ–¥–æ–π—Ç–∏ –∏ –ø–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è", go:"it_hello" },
        { t:"–ù–∞–∑–∞–¥ –≤ –û–£ ‚Ü©Ô∏è", go:"exit_it", class:"back-btn" }
      ]
    },
    it_hello: { file:S.it_hello, color:"#2ecc71",
      hello:{ lineKey:"it", give:"it_give", back:"it_room" }
    },
    it_give: { file:S.it_give, color:"#2ecc71",
      give:{ lineKey:"it", after:"exit_it" }
    },
    exit_it: { file:S.exit_it, next:"ou_hub", color:"#27ae60" },

    exit_ou: { file:S.exit_ou, next:"c1", color:"#333" },

    w_sales: { file:S.walk_sales, next:"c2", color:"#444" },
    c2: { file:S.corr_sales, color:"#d35400",
      btns:[
        { t:"üìà –ó–∞–π—Ç–∏ –≤ –ü—Ä–æ–¥–∞–∂–∏", go:"enter_sales" },
        { t:"–ò–¥—Ç–∏ –¥–∞–ª—å—à–µ ‚û°Ô∏è", go:"w_getit", class:"back-btn" },
        { t:"‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –û–£", go:"c1", class:"back-btn" }
      ]
    },
    enter_sales: { file:S.enter_sales, next:"sales_in", color:"#e67e22" },

    sales_in: { file:S.sales_in, color:"#e67e22",
      btns:[
        { t:"üëã –ü–æ–¥–æ–π—Ç–∏ –∏ –ø–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è", go:"sales_hello" },
        { t:"–í—ã–π—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä ‚Ü©Ô∏è", go:"exit_sales", class:"back-btn" }
      ]
    },
    sales_hello: { file:S.sales_hello, color:"#f39c12",
      hello:{ lineKey:"sales", give:"sales_give", back:"sales_in" }
    },
    sales_give: { file:S.sales_give, color:"#f39c12",
      give:{ lineKey:"sales", after:"exit_sales" }
    },
    exit_sales: { file:S.exit_sales, next:"c2", color:"#d35400" },

    w_getit: { file:S.walk_getit, next:"c3", color:"#444" },
    c3: { file:S.corr_getit, color:"#2980b9",
      btns:[
        { t:"üíª –ó–∞–π—Ç–∏ –≤ Get IT", go:"enter_getit" },
        { t:"–ò–¥—Ç–∏ –¥–∞–ª—å—à–µ ‚û°Ô∏è", go:"w_vnedr", class:"back-btn" },
        { t:"‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –ü—Ä–æ–¥–∞–∂–∞–º", go:"c2", class:"back-btn" }
      ]
    },
    enter_getit: { file:S.enter_getit, next:"getit_in", color:"#3498db" },

    getit_in: { file:S.getit_in, color:"#3498db",
      btns:[
        { t:"üëã –ü–æ–¥–æ–π—Ç–∏ –∏ –ø–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è", go:"getit_hello" },
        { t:"–í—ã–π—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä ‚Ü©Ô∏è", go:"exit_getit", class:"back-btn" }
      ]
    },
    getit_hello: { file:S.getit_hello, color:"#5dade2",
      hello:{ lineKey:"getit", give:"getit_give", back:"getit_in" }
    },
    getit_give: { file:S.getit_give, color:"#5dade2",
      give:{ lineKey:"getit", after:"exit_getit" }
    },
    exit_getit: { file:S.exit_getit, next:"c3", color:"#2980b9" },

    w_vnedr: { file:S.walk_vnedr, next:"c4", color:"#444" },
    c4: { file:S.corr_vnedr, color:"#7f8c8d",
      btns:[
        { t:"üì¶ –ó–∞–π—Ç–∏ –≤–æ –í–Ω–µ–¥—Ä–µ–Ω–∏–µ", go:"enter_vnedr" },
        { t:"–ò–¥—Ç–∏ –Ω–∞ –ö—É—Ö–Ω—é ‚û°Ô∏è", go:"w_kitch", class:"back-btn" },
        { t:"‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ Get IT", go:"c3", class:"back-btn" }
      ]
    },
    enter_vnedr: { file:S.enter_vnedr, next:"vnedr_in", color:"#95a5a6" },

    vnedr_in: { file:S.vnedr_in, color:"#95a5a6",
      btns:[
        { t:"üëã –ü–æ–¥–æ–π—Ç–∏ –∏ –ø–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è", go:"vnedr_hello" },
        { t:"–í—ã–π—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä ‚Ü©Ô∏è", go:"exit_vnedr", class:"back-btn" }
      ]
    },
    vnedr_hello: { file:S.vnedr_hello, color:"#bdc3c7",
      hello:{ lineKey:"vnedr", give:"vnedr_give", back:"vnedr_in" }
    },
    vnedr_give: { file:S.vnedr_give, color:"#bdc3c7",
      give:{ lineKey:"vnedr", after:"exit_vnedr" }
    },
    exit_vnedr: { file:S.exit_vnedr, next:"c4", color:"#7f8c8d" },

    w_kitch: { file:S.walk_kitch, next:"c5", color:"#444" },
    c5: { file:S.corr_kitch, color:"#8e44ad",
      btns:[
        { t:"üçΩÔ∏è –ó–∞–π—Ç–∏ –Ω–∞ –ö—É—Ö–Ω—é", act:"kitchen" },
        { t:"‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –í–Ω–µ–¥—Ä–µ–Ω–∏—é", go:"c4", class:"back-btn" }
      ]
    },

    kitch_lock: { file:S.kitch_lock, next:"c5", color:"#000" },

    kitch_open: { file:S.kitch_open, color:"#ff00ff", showFullScroll:true },

    party: { file:S.party, color:"#ff00ff",
      btns:[
        { t:"‚ú® –°–û–ë–†–ê–¢–¨ –ó–ê–ö–õ–ò–ù–ê–ù–ò–ï ‚ú®", act:"puzzle", class:"alt-btn" },
        { t:"–ù–∞–∑–∞–¥ ‚Ü©Ô∏è", go:"c5", class:"back-btn" }
      ]
    },

    final: { file:S.final, color:"#ffd700", win:true }
  };

  /******** SAVE/LOAD ********/
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      const s = JSON.parse(raw);
      if(!s || !s.userName) return null;
      return s;
    }catch(e){ return null; }
  }
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      userName,
      collected: Array.from(collected),
      currentSceneKey,
      puzzleSolved
    }));
  }
  function applyLoadedState(state){
    userName = state.userName || "–ò–≥—Ä–æ–∫";
    collected = new Set(Array.isArray(state.collected) ? state.collected : []);
    currentSceneKey = state.currentSceneKey || "c1";
    puzzleSolved = !!state.puzzleSolved;
    document.getElementById("count").innerText = collected.size;
  }
  function resetProgress(){
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  /******** AUDIO ********/
  function ensureBGMStarted(){
    bgm.loop = true;
    // —Å—Ç–∞—Ä—Ç—É–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç –∫–ª–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (startActualGame/continueGame)
    bgm.volume = MUSIC_VOL;
    bgm.play().catch(()=>{});
  }
  function setAudioModesForFile(file){
    const isVoice = VOICE_VIDEOS.has(file);
    bgm.volume = isVoice ? 0 : MUSIC_VOL;
    vid.muted = !isVoice;
    vid.volume = isVoice ? 1 : 0;
  }

  /******** POPUP ********/
  let popupNextKey = null;

  function openImagePopup(imgSrc, nextKey){
    popupNextKey = nextKey || null;
    imgPopupImg.src = imgSrc;
    imgPopup.classList.remove("hidden");
  }
  function closeImagePopup(){
    imgPopup.classList.add("hidden");
    const next = popupNextKey;
    popupNextKey = null;
    if(next) playScene(next);
  }
  imgPopupClose.onclick = closeImagePopup;

  /******** VIDEO ENGINE ********/
  function resolveVideoSrc(file){ return VIDEO_BASE + file; }

  function playScene(key){
    const s = scenes[key];
    currentSceneKey = key;
    saveState();

    // –∑–≤—É–∫
    setAudioModesForFile(s.file);

    // –∫–Ω–æ–ø–∫–∏ –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–∏–¥–µ–æ
    ui.classList.add("hidden");
    ui.innerHTML = "";

    fallback.style.background = s.color || "#333";
    fallback.innerText = "";

    vid.onended = null;
    vid.onerror = null;

    vid.src = resolveVideoSrc(s.file);

const is04 = (s.file === LOOP_ONLY_FILE);

// –ª—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è 04
vid.loop = is04;

// –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω –∂–¥—ë–º –∫–æ–Ω—Ü–∞ –≤–∏–¥–µ–æ


    vid.onerror = () => {
      // –±–µ–∑ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞ –æ—Å—Ç–∞–≤–∏–º —á—ë—Ä–Ω—ã–π
      // –º–æ–∂–Ω–æ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ alert, –Ω–æ —Ç—ã –ø—Ä–æ—Å–∏–ª–∞ —É–±—Ä–∞—Ç—å
    };

    vid.onended = is04 ? null : () => onVideoEnd(s);

    vid.play().catch(()=>{});

// –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: –≤ 04 –∫–Ω–æ–ø–∫–∏ —Å—Ä–∞–∑—É
if (is04 && (s.btns || s.hello)) {
  showBtns(s);
  }

  function onVideoEnd(s){
    // give ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É-—Å—Ç—Ä–æ—á–∫—É
    if(s.give){
      const id = LINE_ID[s.give.lineKey];
      grantLineImage(id, s.give.after);
      return;
    }

    // –ø–æ—Å–ª–µ 42 ‚Üí –ø–æ–ª–Ω—ã–π —Å–≤–∏—Ç–æ–∫, –∑–∞–∫—Ä—ã–ª–∏ ‚Üí party
    if(s.showFullScroll){
      openImagePopup(FULL_SCROLL_IMG, "party");
      return;
    }

    // –ø–µ—Ä–µ—Ö–æ–¥—ã
    if(s.next){
      playScene(s.next);
      return;
    }

    // –ø–æ–±–µ–¥–∞
    if(s.win){
      showWin();
      return;
    }

    // –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∫–æ–Ω—Ü–∞)
    if(s.btns || s.hello){
      showBtns(s);
    }

    // –ª—É–ø —Ç–æ–ª—å–∫–æ —É 04: –ø–æ—Å–ª–µ –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –Ω–∞—á–∏–Ω–∞–µ–º –ø–æ–≤—Ç–æ—Ä—è—Ç—å –≤–∏–¥–µ–æ –≤ —Ñ–æ–Ω–µ
    if(s.file === LOOP_ONLY_FILE){
      try{
        vid.onended = () => {
          vid.currentTime = 0;
          vid.play().catch(()=>{});
        };
        vid.currentTime = 0;
        vid.play().catch(()=>{});
      }catch(e){}
    }
  }

  function showBtns(s){
    ui.innerHTML = "";
    ui.classList.remove("hidden");

    if(s.hello){
      const lineId = LINE_ID[s.hello.lineKey];
      const already = collected.has(lineId);

      const btnHello = document.createElement("button");
      btnHello.innerText = already ? "–ü–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è (–ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å) üëã" : "–ü–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è üëã";
      btnHello.onclick = () => playScene(s.hello.give);

      const btnBack = document.createElement("button");
      btnBack.innerText = "–ù–∞–∑–∞–¥";
      btnBack.className = "back-btn";
      btnBack.onclick = () => playScene(s.hello.back);

      ui.append(btnHello, btnBack);
      return;
    }

    (s.btns || []).forEach(b=>{
      const btn = document.createElement("button");
      btn.innerText = b.t;
      if(b.class) btn.classList.add(b.class);
      btn.onclick = () => {
        if(b.go) return playScene(b.go);
        if(b.act === "kitchen") return tryKitchen();
        if(b.act === "puzzle") return openPuzzle();
      };
      ui.appendChild(btn);
    });
  }

  function grantLineImage(id, returnKey){
    if(!collected.has(id)){
      collected.add(id);
      document.getElementById("count").innerText = collected.size;
      saveState();
      sendTg(`üìú <b>${userName}</b> –Ω–∞—à—ë–ª(–∞) —Å—Ç—Ä–æ—á–∫—É #${id}`);
    }
    openImagePopup(LINE_IMG[id], returnKey || "ou_hub");
  }

  function tryKitchen(){
    if(collected.size >= TOTAL_LINES) playScene("kitch_open");
    else{
      alert("–ù—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–æ—á–∫–∏!");
      playScene("kitch_lock");
    }
  }

  /******** PUZZLE ********/
  let puzzlePicked = [];
  let puzzleShuffled = [];

  function openPuzzle(){
    if(collected.size < TOTAL_LINES) return alert("–°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–∏ –≤—Å–µ 8 —Å—Ç—Ä–æ–∫!");
    document.getElementById("puzzleScreen").classList.remove("hidden");
    renderPuzzle();
  }
  function closePuzzle(){ document.getElementById("puzzleScreen").classList.add("hidden"); }

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function renderPuzzle(){
    const all = Array.from({length:TOTAL_LINES}, (_,i)=>i+1);
    puzzleShuffled = shuffle(all);
    puzzlePicked = [];
    document.getElementById("puzzleHint").innerText = "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ ‚Äî –∫–∞–∫ —á–∏—Ç–∞–µ—Ç—Å—è —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ.";

    const pills = document.getElementById("puzzlePills");
    pills.innerHTML = "";
    puzzleShuffled.forEach(id=>{
      const el = document.createElement("span");
      el.className = "pill";
      el.dataset.id = id;
      el.innerText = POEM_LINES[id];
      el.onclick = ()=> puzzlePick(id);
      pills.appendChild(el);
    });
    updatePuzzleOrderUI();
  }

  function puzzlePick(id){
    if(puzzlePicked.includes(id)) return;
    puzzlePicked.push(id);
    document.querySelectorAll(".pill").forEach(p=>{
      if(Number(p.dataset.id) === id) p.classList.add("used");
    });
    updatePuzzleOrderUI();
  }

  function updatePuzzleOrderUI(){
    const box = document.getElementById("puzzleOrder");
    if(puzzlePicked.length === 0){
      box.innerHTML = "<div style='color:#aaa;'>–¢–≤–æ–π –ø–æ—Ä—è–¥–æ–∫ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶</div>";
      return;
    }
    box.innerHTML = puzzlePicked.map((id, idx)=>(
      `<div class="orderLine"><b>${idx+1}.</b> ${POEM_LINES[id]}</div>`
    )).join("");
  }

  function puzzleReset(){ renderPuzzle(); }

  function puzzleCheck(){
    const need = Array.from({length:TOTAL_LINES}, (_,i)=>i+1);
    if(puzzlePicked.length !== TOTAL_LINES) return alert("–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –≤—Å–µ 8 —Å—Ç—Ä–æ–∫.");
    const ok = need.every((id, idx)=> puzzlePicked[idx] === id);
    if(ok){
      puzzleSolved = true;
      saveState();
      closePuzzle();
      alert("–ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–æ! ‚ú®");
      sendTg(`‚ú® <b>${userName}</b> —Å–æ–±—Ä–∞–ª(–∞) –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ!`);
      playScene("final");
    }else{
      alert("–ü–æ—á—Ç–∏! –ù–æ –ø–æ—Ä—è–¥–æ–∫ –Ω–µ–≤–µ—Ä–Ω—ã–π üòÖ");
    }
  }

  /******** FLOW ********/
  function showRules(){
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("rulesScreen").classList.remove("hidden");
  }
  function backToLogin(){
    document.getElementById("rulesScreen").classList.add("hidden");
    document.getElementById("loginScreen").classList.remove("hidden");
  }

  function startGame(){
    const input = document.getElementById("username");
    if(!input.value.trim()) return alert("–í–≤–µ–¥–∏ –∏–º—è!");
    userName = input.value.trim();
    saveState();
    showRules();
  }

  function startActualGame(){
    document.getElementById("rulesScreen").classList.add("hidden");
    document.getElementById("inventory").style.display = "block";

    ensureBGMStarted();
    sendTg(`üöÄ <b>${userName}</b> –Ω–∞—á–∞–ª(–∞) –∏–≥—Ä—É!`);

    playScene("lift");
  }

  function continueGame(){
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("inventory").style.display = "block";

    ensureBGMStarted();
    playScene(currentSceneKey === "attract" ? "lift" : currentSceneKey);
    sendTg(`üîÅ <b>${userName}</b> –ø—Ä–æ–¥–æ–ª–∂–∏–ª(–∞) –∏–≥—Ä—É.`);
  }

  function showWin(){
    try { bgm.volume = 0; bgm.pause(); } catch(e) {}
    document.getElementById("winScreen").classList.remove("hidden");
    sendTg(`üèÜ <b>${userName}</b> –ü–†–û–®–Å–õ(–ê) –ò–ì–†–£!`);
  }

  /******** BOOT ********/
  (function boot(){
    // (00 –Ω–∞ —Ñ–æ–Ω–µ –ª–æ–≥–∏–Ω–∞ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—á–Ω–æ ‚Äî –±–µ–∑ –ª—É–ø–æ–≤)
    vid.src = VIDEO_BASE + S.intro;
    vid.loop = false;
    vid.muted = true;
    vid.volume = 0;
    vid.play().catch(()=>{});

    const state = loadState();
    if(state){
      applyLoadedState(state);
      document.getElementById("savedName").innerText = userName;
      document.getElementById("continueBox").classList.remove("hidden");
      document.getElementById("newGameBox").classList.add("hidden");
    }
  })();
</script>
</body>
</html>
