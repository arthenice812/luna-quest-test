<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>QUEST: –õ—É–Ω–∞ –ø—Ä–æ—Ç–∏–≤ –°–µ—Ä–æ—Å—Ç–∏</title>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap");

    :root{
      --gold:#ffd700;
      --green:#2d5a27;
      --bg:#000;
    }

    body{
      margin:0;
      background:var(--bg);
      color:#fff;
      font-family:"Montserrat",sans-serif;
      overflow:hidden;
      height:100vh;
    }

    #game-container{
      position:relative;
      width:100%;
      height:100%;
      max-width:500px;
      margin:0 auto;
      background:#111;
    }

    video{
      width:100%;
      height:100%;
      object-fit:cover;
      position:absolute;
      inset:0;
      z-index:1;
      background:#000;
    }

    #fallback-screen{
      position:absolute;
      inset:0;
      z-index:0;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:20px;
      font-size:1.1rem;
      font-weight:700;
      transition:background .5s ease;
      white-space:pre-line;
      opacity:.9;
    }

    /* –≠–§–§–ï–ö–¢ "–°–ï–†–û–°–¢–¨" (—É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞) */
    #fxNoise{
      position:absolute;
      inset:0;
      z-index:5;
      pointer-events:none;
      opacity:.55;
      mix-blend-mode:overlay;
      background:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,.08), transparent 40%),
        radial-gradient(circle at 80% 30%, rgba(255,255,255,.05), transparent 35%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.05), rgba(255,255,255,.05) 1px, transparent 1px, transparent 3px);
      filter:blur(.3px);
      transition:opacity .35s ease;
    }
    #fxVignette{
      position:absolute;
      inset:0;
      z-index:6;
      pointer-events:none;
      background:radial-gradient(ellipse at center, transparent 35%, rgba(0,0,0,.75) 100%);
      opacity:.75;
      transition:opacity .35s ease;
    }

    .ui-layer{
      position:absolute;
      inset:0;
      z-index:10;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding:20px 30px;
      box-sizing:border-box;
      background:linear-gradient(to top, rgba(0,0,0,.9), transparent 60%);
      pointer-events:none;
    }

    button{
      pointer-events:auto;
      background:rgba(60,50,75,.9);
      color:#fff;
      border:3px solid var(--green);
      border-radius:15px;
      padding:14px;
      margin:6px 0;
      font-weight:700;
      font-size:.95rem;
      cursor:pointer;
      text-transform:uppercase;
      box-shadow:0 0 5px var(--green), 0 0 0 1px #c0392b inset;
      width:100%;
      position:relative;
      backdrop-filter:blur(5px);
      transition:transform .1s, opacity .2s;
    }
    button:active{ transform:scale(.96); }
    button::before{ content:"üéÑ "; margin-right:5px; }

    button.back-btn{
      background:rgba(40,40,40,.9);
      border-color:#555;
      box-shadow:none;
      font-size:.9rem;
      margin-top:10px;
      text-transform:none;
    }
    button.back-btn::before{ content:"‚Ü©Ô∏è "; }

    button.alt-btn{
      background:rgba(0,0,0,.55);
      border-color:var(--gold);
      box-shadow:0 0 10px rgba(255,215,0,.2);
      text-transform:none;
    }
    button.alt-btn::before{ content:"‚ú® "; }

    .modal-box{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      width:90%;
      background:rgba(20,15,30,.98);
      border:3px solid var(--gold);
      border-radius:20px;
      padding:22px;
      z-index:20;
      text-align:center;
      pointer-events:auto;
      box-shadow:0 0 30px rgba(0,0,0,.8);
    }
    .modal-text{
      font-size:1rem;
      margin-bottom:16px;
      line-height:1.4;
      text-align:left;
    }
    .question{
      color:#aaa;
      font-style:italic;
      margin-bottom:10px;
      border-left:2px solid var(--gold);
      padding-left:10px;
    }
    .dialog-btns{ display:flex; flex-direction:column; gap:10px; }

    .scroll-popup{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.9);
      z-index:50;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      animation:fadeIn .5s;
    }
    .scroll-content{
      background:#fff5e6;
      color:#4a3b2a;
      padding:36px 20px;
      border-radius:6px;
      max-width:86%;
      text-align:center;
      box-shadow:0 0 50px var(--gold);
      transform:scale(0);
      animation:scaleIn .5s forwards;
      border:8px double #8b4513;
    }

    .overlay{
      position:absolute;
      inset:0;
      z-index:100;
      background:rgba(10,5,20,.98);
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding:30px;
      box-sizing:border-box;
    }
    .hidden{ display:none !important; }

    input{
      padding:15px;
      border-radius:10px;
      border:2px solid var(--green);
      background:#222;
      color:#fff;
      font-size:1.05rem;
      margin:12px 0 18px;
      width:100%;
      box-sizing:border-box;
      text-align:center;
    }

    #inventory{
      position:absolute;
      top:18px;
      right:18px;
      z-index:15;
      background:rgba(45,90,39,.8);
      padding:8px 14px;
      border-radius:20px;
      border:2px solid var(--gold);
      font-weight:700;
      color:#fff;
      display:none;
      box-shadow:0 0 12px rgba(0,0,0,.35);
    }

    /* –ü–ê–ó–õ */
    #puzzleScreen .modal-text{ text-align:left; font-size:.95rem; }
    .pill{
      display:inline-block;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.08);
      margin:6px 6px 0 0;
      cursor:pointer;
      user-select:none;
      font-size:.9rem;
      line-height:1.2;
    }
    .pill:hover{ background:rgba(255,255,255,.14); }
    .pill.used{
      opacity:.35;
      pointer-events:none;
      text-decoration:line-through;
    }
    .orderBox{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:2px dashed rgba(255,215,0,.7);
      background:rgba(0,0,0,.25);
      min-height:64px;
      text-align:left;
      font-size:.95rem;
    }
    .orderLine{
      margin:6px 0;
      padding:10px 10px;
      border-radius:12px;
      background:rgba(255,215,0,.12);
      border:1px solid rgba(255,215,0,.25);
    }

    @keyframes scaleIn{ from{ transform:scale(0) rotate(-10deg);} to{ transform:scale(1) rotate(0);} }
    @keyframes fadeIn{ from{ opacity:0;} to{ opacity:1;} }
  </style>
</head>

<body>
<div id="game-container">
  <div id="fallback-screen">–ó–ê–ì–†–£–ó–ö–ê...</div>
  <video id="vid" playsinline webkit-playsinline muted></video>

  <div id="fxNoise"></div>
  <div id="fxVignette"></div>

  <div id="inventory">üìú –°–≤–∏—Ç–æ–∫: <span id="count">0</span>/8</div>
  <div id="ui" class="ui-layer hidden"></div>

  <div id="dialog" class="modal-box hidden">
    <div id="dialog-content" class="modal-text"></div>
    <div id="dialog-buttons" class="dialog-btns"></div>
  </div>

  <div id="rulesScreen" class="modal-box hidden" style="z-index:110;">
    <h2 style="color:var(--gold);margin-top:0;">–ü–†–ê–í–ò–õ–ê –ò–ì–†–´ üéÑ</h2>
    <div class="modal-text" style="font-size:.95rem;">
      1) –¢—ã –≤ –æ—Ñ–∏—Å–µ "Open Service".<br/>
      2) –¶–µ–ª—å: –Ω–∞–π—Ç–∏ 8 —á–∞—Å—Ç–µ–π –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è.<br/>
      3) –ó–∞—Ö–æ–¥–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç—ã –∏ –ø—Ä–æ—Ö–æ–¥–∏ –º–∏–Ω–∏-–≤–∏–∫—Ç–æ—Ä–∏–Ω—ã —É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.<br/>
      4) –°–æ–±–µ—Ä–∏ –≤—Å—ë, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å –Ω–∞ –ö—É—Ö–Ω—é.<br/>
      5) –í –∫–æ–Ω—Ü–µ ‚Äî —Å–æ–±–µ—Ä–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.
    </div>
    <button onclick="startActualGame()">–ü–û–ì–ù–ê–õ–ò! üöÄ</button>
  </div>

  <div id="scrollPopup" class="scroll-popup hidden">
    <div class="scroll-content">
      <h3 style="margin:0;color:#8b4513">‚ú® –°–¢–†–û–ß–ö–ê –ù–ê–ô–î–ï–ù–ê ‚ú®</h3>
      <p style="font-family:Georgia;font-style:italic;font-size:1.15rem;font-weight:700;margin:18px 0;" id="scrollLineText">...</p>
      <button onclick="closeScroll()" style="background:#8b4513;border-color:#5a2d0c;box-shadow:none;">–í –ò–ù–í–ï–ù–¢–ê–†–¨</button>
    </div>
  </div>

  <!-- –õ–û–ì–ò–ù -->
  <div id="loginScreen" class="overlay">
    <h1 style="color:var(--gold);text-shadow:0 0 10px #ff0000;margin:0 0 10px;">üéÑ –õ–£–ù–ê v –°–ï–†–û–°–¢–¨ üéÑ</h1>
    <p style="margin:0 0 12px;">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–≤–µ—Å—Ç.<br/>–°–æ–±–µ—Ä–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ, —Å–ø–∞—Å–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫.</p>

    <div id="continueBox" class="modal-box hidden" style="position:relative;transform:none;top:auto;left:auto;width:100%;max-width:420px;">
      <div class="modal-text" style="text-align:center;">
        –ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è <b id="savedName">–ò–≥—Ä–æ–∫</b>.<br/>
        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?
      </div>
      <button onclick="continueGame()" class="alt-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      <button onclick="resetProgress()" class="back-btn">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    </div>

    <div id="newGameBox" style="width:100%;max-width:420px;">
      <input type="text" id="username" placeholder="–¢–≤–æ—ë –∏–º—è" />
      <button onclick="showRules()">–ù–ê–ß–ê–¢–¨</button>
    </div>
  </div>

  <!-- –ü–ê–ó–õ -->
  <div id="puzzleScreen" class="modal-box hidden" style="z-index:120;">
    <h2 style="color:var(--gold);margin-top:0;">‚ú® –°–û–ë–ï–†–ò –ó–ê–ö–õ–ò–ù–ê–ù–ò–ï ‚ú®</h2>
    <div class="modal-text">
      –ù–∞–∂–∏–º–∞–π –Ω–∞ —Å—Ç—Ä–æ–∫–∏ (–æ–Ω–∏ –ø–µ—Ä–µ–º–µ—à–∞–Ω—ã), —á—Ç–æ–±—ã –≤—ã—Å—Ç—Ä–æ–∏—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.<br/>
      –ï—Å–ª–∏ –æ—à–∏–±—ë—à—å—Å—è ‚Äî –º–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞.
    </div>
    <div id="puzzlePills"></div>
    <div class="orderBox" id="puzzleOrder"></div>
    <div style="display:flex;gap:10px;margin-top:12px;">
      <button onclick="puzzleReset()" class="back-btn" style="margin:0;flex:1;">–°–ë–†–û–°</button>
      <button onclick="puzzleCheck()" class="alt-btn" style="margin:0;flex:1;">–ü–†–û–í–ï–†–ò–¢–¨</button>
    </div>
    <button onclick="closePuzzle()" class="back-btn">–ù–∞–∑–∞–¥</button>
    <div id="puzzleHint" style="margin-top:10px;color:#aaa;font-size:.9rem;"></div>
  </div>

  <div id="winScreen" class="overlay hidden">
    <h1 style="color:var(--gold);margin:0 0 10px;">–ü–û–ë–ï–î–ê!</h1>
    <p style="margin:0 0 16px;">–¢—ã —Å–æ–±—Ä–∞–ª(–∞) –≤—Å—ë –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ!<br/>–ù–æ–≤—ã–π –≥–æ–¥ —Å–ø–∞—Å—ë–Ω!</p>
    <button onclick="resetProgress()">–í –ú–ï–ù–Æ</button>
  </div>
</div>

<script>
  /***********************
   * TELEGRAM
   ***********************/
  const TELEGRAM_ENABLED = true;

  // –í—Å—Ç–∞–≤—å —Å–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è:
  const TG_TOKEN = "8287827338:AAEaIEkNbJuk_6oFR5lEmLCQ0nObVKvpmsg";
  const TG_CHAT_ID = "7524680591";

  /***********************
   * –û–°–ù–û–í–ù–û–ï
   ***********************/
  const TOTAL_LINES = 8;
  const STORAGE_KEY = "quest_state_v2";

  const vid = document.getElementById("vid");
  const fallback = document.getElementById("fallback-screen");
  const ui = document.getElementById("ui");
  const dialog = document.getElementById("dialog");
  const fxNoise = document.getElementById("fxNoise");
  const fxVignette = document.getElementById("fxVignette");

  let collected = new Set();
  let userName = "–ò–≥—Ä–æ–∫";
  let videoTimeout = null;
  let currentSceneKey = "intro";
  let puzzleSolved = false;

  // –ó–∞–≥–ª—É—à–∫–∏ (–µ—Å–ª–∏ –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ)
  const V_LOOP = "https://media.istockphoto.com/id/1363653139/video/abstract-background.mp4?s=mp4-640x640-is&k=20&c=6a_aQjQGkY3XFjF9p0yqQ1qXqQ4Q4Q4Q4Q4Q4Q4Q4Q=";
  const V_WIN  = "https://media.istockphoto.com/id/1183318283/video/fireworks.mp4?s=mp4-640x640-is&k=20&c=6a_aQjQGkY3XFjF9p0yqQ1qXqQ4Q4Q4Q4Q4Q4Q4Q4Q=";

  const USE_LOCAL_VIDEOS = false;   // –≤–∫–ª—é—á–∏, –∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏—à—å —Å–≤–æ–∏ mp4
  const VIDEO_BASE = "./videos/";   // –ø–∞–ø–∫–∞ —Å mp4

  const POEM_LINES = {
    1: "–ó–∞–∂–∂—ë–º —Å–µ—Ä–¥—Ü–∞, –ø—Ä–æ–≥–æ–Ω–∏–º –ø—Ä–æ—á—å —Ç–æ—Å–∫—É,",
    2: "–ö–ª–∏–µ–Ω—Ç –¥–æ–≤–æ–ª–µ–Ω ‚Äî –º—ã –≤—Å–µ–≥–¥–∞ –Ω–∞ —á–µ–∫—É!",
    3: "–°–≤–µ–¥—ë–º –±–∞–ª–∞–Ω—Å: –∫–æ–ø–µ–π–∫–∞ –¥–æ —Ä—É–±–ª—è,",
    4: "–ò –Ω–µ –∑–∞–≤–∏—Å–Ω–µ—Ç —Å–µ—Ä–≤–µ—Ä –Ω–∏–∫–æ–≥–¥–∞!",
    5: "–°—Ç—Ä–∞—Ç–µ–≥–∏—è —è—Å–Ω–∞, –±—é–¥–∂–µ—Ç —Ä–∞—Å—Ç—ë—Ç,",
    6: "–ü–æ–±—å—ë–º —Ä–µ–∫–æ—Ä–¥—ã –≤ —ç—Ç–æ—Ç –ù–æ–≤—ã–π –≥–æ–¥!",
    7: "–°–∏—Å—Ç–µ–º–∞ ‚Äî –≤ –Ω–æ—Ä–º–µ, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ ‚Äî –∏–¥–µ–∞–ª,",
    8: "–ß—Ç–æ–± —á–∏—Å—Ç—ã–π –∫–æ–¥ –ø–æ–±–µ–¥—É –Ω–∞–º –∫–æ–≤–∞–ª!"
  };

  const ACTS = {
    happy: {
      speaker: "–ß–∞—Å—Ç–∏—á–∫–∞ —Å—á–∞—Å—Ç—å—è",
      q: "–ß—Ç–æ –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø—Ä–æ–≥–æ–Ω—è–µ—Ç –æ—Ñ–∏—Å–Ω—É—é —Å–µ—Ä–æ—Å—Ç—å?",
      options: ["–°—É—Ö–∏–µ –æ—Ç—á—ë—Ç—ã –±–µ–∑ —É–ª—ã–±–∫–∏", "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –∫—É–ª—å—Ç—É—Ä–∞ –∏ –∑–∞–±–æ—Ç–∞", "–û—Ç–∫–ª—é—á–∏—Ç—å –≤—Å–µ–º –∫–æ—Ñ–µ-–º–∞—à–∏–Ω—É"],
      correct: 1,
      lineId: 1
    },
    client: {
      speaker: "–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —É—á—ë—Ç",
      q: "–ß—Ç–æ –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ –≤ —Ä–∞–±–æ—Ç–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º?",
      options: ["–ü—Ä–æ–ø–∞—Å—Ç—å –Ω–∞ 3 –¥–Ω—è", "–ë—ã—Ç—å –Ω–∞ —Å–≤—è–∑–∏ –∏ –ø–æ–º–æ–≥–∞—Ç—å", "–û—Ç–≤–µ—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –º–µ–º–∞–º–∏"],
      correct: 1,
      lineId: 2
    },
    gen: {
      speaker: "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —É—á—ë—Ç",
      q: "–ö–∞–∫–æ–π –ø—Ä–∏–Ω—Ü–∏–ø —É —É—á—ë—Ç–∞ —Å–∞–º—ã–π –ª—é–±–∏–º—ã–π?",
      options: ["–ö–∞–∫-–Ω–∏–±—É–¥—å —Å–æ–π–¥—ë—Ç—Å—è", "–¢–æ—á–Ω–æ—Å—Ç—å –∏ –ø–æ—Ä—è–¥–æ–∫", "–°—á–∏—Ç–∞—Ç—å –Ω–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ –∏–∑ 90-—Ö –±–µ–∑ –±–∞—Ç–∞—Ä–µ–µ–∫"],
      correct: 1,
      lineId: 3
    },
    it: {
      speaker: "IT",
      q: "–ß—Ç–æ –¥–µ–ª–∞–µ—Ç IT, –∫–æ–≥–¥–∞ —É –≤—Å–µ—Ö –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç?",
      options: ["–°–º–æ—Ç—Ä–∏—Ç –≤ —Å—Ç–µ–Ω—É", "–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã –∑–∞—Ä–∞–Ω–µ–µ", "–ù–∞–∂–∏–º–∞–µ—Ç Ctrl+Alt+Del –Ω–∞ –≤—Å—ë–º –ø–æ–¥—Ä—è–¥"],
      correct: 1,
      lineId: 4
    },
    fd: {
      speaker: "–§–∏–Ω–î–∏—Ä",
      q: "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ö–æ—Ä–æ—à–∏–π –±—é–¥–∂–µ—Ç –Ω–∞ –≥–æ–¥?",
      options: ["–≠—Ç–æ –º–∏—Ñ", "–≠—Ç–æ –ø–ª–∞–Ω + –∫–æ–Ω—Ç—Ä–æ–ª—å + –≥–∏–±–∫–æ—Å—Ç—å", "–≠—Ç–æ –∫–æ–≥–¥–∞ –≤—Å–µ –¥–µ–Ω—å–≥–∏ —É—à–ª–∏ –Ω–∞ –≥–∏—Ä–ª—è–Ω–¥—ã"],
      correct: 1,
      lineId: 5
    },
    sales: {
      speaker: "–ü—Ä–æ–¥–∞–∂–∏",
      q: "–ß—Ç–æ –±–ª–∏–∂–µ –≤—Å–µ–≥–æ –∫ –¥—É—Ö—É –ø—Ä–æ–¥–∞–∂?",
      options: ["–¢–∏—à–∏–Ω–∞ –∏ –ø–æ–∫–æ–π", "–†–µ–∑—É–ª—å—Ç–∞—Ç, –¥—Ä–∞–π–≤ –∏ —Ä–µ–∫–æ—Ä–¥—ã", "–û—Ç–∫–ª—é—á–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞–≤—Å–µ–≥–¥–∞"],
      correct: 1,
      lineId: 6
    },
    vnedr: {
      speaker: "–í–Ω–µ–¥—Ä–µ–Ω–∏–µ",
      q: "–ö–æ–≥–¥–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–º?",
      options: ["–ö–æ–≥–¥–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–º–µ—Ç–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏–π", "–ö–æ–≥–¥–∞ –≤—Å—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —É –∫–ª–∏–µ–Ω—Ç–∞", "–ö–æ–≥–¥–∞ —Å–∫–ª–∞–¥ —Å–∞–º —Å–µ–±—è –ø–æ—Å—á–∏—Ç–∞–ª"],
      correct: 1,
      lineId: 7
    },
    getit: {
      speaker: "Get IT",
      q: "–ì–ª–∞–≤–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫ —Ö–æ—Ä–æ—à–µ–≥–æ –∫–æ–¥–∞?",
      options: ["–ß–∏—Å—Ç–æ—Ç–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å", "–ß–µ–º –±–æ–ª—å—à–µ —Å—Ç—Ä–æ–∫ ‚Äî —Ç–µ–º –ª—É—á—à–µ", "–ö–æ–º–º–µ–Ω—Ç—ã –≤ —Å—Ç–∏–ª–µ ¬´–Ω–µ —Ç—Ä–æ–≥–∞—Ç—å, –æ–Ω–æ –∂–∏–≤—ë—Ç¬ª"],
      correct: 0,
      lineId: 8
    }
  };

  const S = {
    intro: "00_intro.mp4",
    lift: "01_lift_open.mp4",

    corr_ou: "02_corridor_ou.mp4",
    enter_ou: "03_enter_ou.mp4",
    ou_in: "04_ou_inside.mp4",
    exit_ou: "14_exit_ou.mp4",

    talk_happy: "05_talk_happy.mp4",
    talk_client: "06_talk_client.mp4",
    talk_gen: "07_talk_general.mp4",

    enter_it: "08_enter_it.mp4",
    talk_it: "09_talk_it.mp4",
    exit_it: "10_exit_it.mp4",

    enter_fd: "11_enter_findir.mp4",
    talk_fd: "12_talk_findir.mp4",
    exit_fd: "13_exit_findir.mp4",

    walk_sales: "15_walk_to_sales.mp4",
    corr_sales: "16_corridor_sales.mp4",
    enter_sales: "17_enter_sales.mp4",
    sales_in: "18_sales_inside.mp4",
    talk_sales: "19_talk_sales.mp4",
    exit_sales: "20_exit_sales.mp4",

    walk_getit: "21_walk_to_getit.mp4",
    corr_getit: "22_corridor_getit.mp4",
    enter_getit: "23_enter_getit.mp4",
    getit_in: "24_getit_inside.mp4",
    talk_getit: "25_talk_getit.mp4",
    exit_getit: "26_exit_getit.mp4",

    walk_vnedr: "27_walk_to_vnedr.mp4",
    corr_vnedr: "28_corridor_vnedr.mp4",
    enter_vnedr: "29_enter_vnedr.mp4",
    vnedr_in: "30_vnedr_inside.mp4",
    talk_vnedr: "31_talk_vnedr.mp4",
    exit_vnedr: "32_exit_vnedr.mp4",

    walk_kitch: "33_walk_to_kitchen.mp4",
    corr_kitch: "34_corridor_kitchen.mp4",
    kitch_lock: "35_kitchen_locked.mp4",
    kitch_open: "36_kitchen_open.mp4",
    party: "37_party_loop.mp4",
    final: "38_final.mp4"
  };

  // –í–ê–ñ–ù–û: talk_* –∏—Å–ø–æ–ª—å–∑—É—é—Ç file (—ç—Ç–æ —Ñ–∏–∫—Å ‚Äú–ª–æ–º–∞–µ—Ç—Å—è‚Äù)
  const scenes = {
    intro: { file: S.intro, loop: true, color: "#111" },   // –ø—Ä–æ–ª–æ–≥, 4 —Å–µ–∫, –ø–æ—Ç–æ–º –ª–∏—Ñ—Ç
    lift:  { file: S.lift, next: "c1", color: "#222" },

    c1: { file: S.corr_ou, loop: true, color: "#2c3e50",
      btns: [
        { t: "üìÇ –ó–∞–π—Ç–∏ –≤ –û—Ç–¥–µ–ª –£—á—ë—Ç–∞", go: "enter_ou" },
        { t: "–ò–¥—Ç–∏ –¥–∞–ª—å—à–µ ‚û°Ô∏è", go: "w_sales", class: "back-btn" }
      ]
    },

    enter_ou: { file: S.enter_ou, next: "ou_hub", color: "#c0392b" },

    ou_hub: { file: S.ou_in, loop: true, color: "#c0392b",
      btns: [
        { t: '‚ú® –ü–æ–¥–æ–π—Ç–∏ –∫ "–°—á–∞—Å—Ç—å—é"', act: "happy" },
        { t: "üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –£—á—ë—Ç–∞", go: "ou_sub" },
        { t: "üíª –ó–∞–π—Ç–∏ –≤ IT", go: "enter_it" },
        { t: "üíº –ó–∞–π—Ç–∏ –∫ –§–∏–Ω–î–∏—Ä—É", go: "enter_fd" },
        { t: "–í—ã–π—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä ‚Ü©Ô∏è", go: "exit_ou", class: "back-btn" }
      ]
    },

    ou_sub: { file: S.ou_in, loop: true, color: "#a93226",
      btns: [
        { t: "üìÑ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —É—á—ë—Ç", act: "gen" },
        { t: "ü§ù –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –æ—Ç–¥–µ–ª", act: "client" },
        { t: "–ù–∞–∑–∞–¥ –≤ —Ü–µ–Ω—Ç—Ä –û–£ ‚Ü©Ô∏è", go: "ou_hub", class: "back-btn" }
      ]
    },

    talk_happy:  { file: S.talk_happy,  color: "#e74c3c", quizAct: "happy"  },
    talk_client: { file: S.talk_client, color: "#e74c3c", quizAct: "client" },
    talk_gen:    { file: S.talk_gen,    color: "#e74c3c", quizAct: "gen"    },

    enter_it: { file: S.enter_it, loop: true, color: "#27ae60",
      btns: [
        { t: "üíª –ì–æ–≤–æ—Ä–∏—Ç—å —Å IT", act: "it" },
        { t: "–ù–∞–∑–∞–¥ –≤ –û–£", go: "exit_it", class: "back-btn" }
      ]
    },
    talk_it: { file: S.talk_it, color: "#2ecc71", quizAct: "it", afterQuizReturn: "enter_it" },
    exit_it: { file: S.exit_it, next: "ou_hub", color: "#27ae60" },

    enter_fd: { file: S.enter_fd, loop: true, color: "#8e44ad",
      btns: [
        { t: "üíº –ì–æ–≤–æ—Ä–∏—Ç—å —Å –§–∏–Ω–î–∏—Ä–æ–º", act: "fd" },
        { t: "–ù–∞–∑–∞–¥ –≤ –û–£", go: "exit_fd", class: "back-btn" }
      ]
    },
    talk_fd: { file: S.talk_fd, color: "#9b59b6", quizAct: "fd", afterQuizReturn: "enter_fd" },
    exit_fd: { file: S.exit_fd, next: "ou_hub", color: "#8e44ad" },

    exit_ou: { file: S.exit_ou, next: "c1", color: "#333" },

    w_sales: { file: S.walk_sales, next: "c2", color: "#444" },
    c2: { file: S.corr_sales, loop: true, color: "#d35400",
      btns: [
        { t: "üìà –ó–∞–π—Ç–∏ –≤ –ü—Ä–æ–¥–∞–∂–∏", go: "enter_sales" },
        { t: "–ò–¥—Ç–∏ –¥–∞–ª—å—à–µ ‚û°Ô∏è", go: "w_getit", class: "back-btn" },
        { t: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –û–£", go: "c1", class: "back-btn" }
      ]
    },
    enter_sales: { file: S.enter_sales, next: "sales_in", color: "#e67e22" },
    sales_in: { file: S.sales_in, loop: true, color: "#e67e22",
      btns: [
        { t: "üó£ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å", act: "sales" },
        { t: "–í—ã–π—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä", go: "exit_sales", class: "back-btn" }
      ]
    },
    talk_sales: { file: S.talk_sales, color: "#f39c12", quizAct: "sales", afterQuizReturn: "sales_in" },
    exit_sales: { file: S.exit_sales, next: "c2", color: "#d35400" },

    w_getit: { file: S.walk_getit, next: "c3", color: "#444" },
    c3: { file: S.corr_getit, loop: true, color: "#2980b9",
      btns: [
        { t: "üíª –ó–∞–π—Ç–∏ –≤ Get IT", go: "enter_getit" },
        { t: "–ò–¥—Ç–∏ –¥–∞–ª—å—à–µ ‚û°Ô∏è", go: "w_vnedr", class: "back-btn" },
        { t: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –ü—Ä–æ–¥–∞–∂–∞–º", go: "c2", class: "back-btn" }
      ]
    },
    enter_getit: { file: S.enter_getit, next: "getit_in", color: "#3498db" },
    getit_in: { file: S.getit_in, loop: true, color: "#3498db",
      btns: [
        { t: "üë®‚Äçüíª –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å", act: "getit" },
        { t: "–í—ã–π—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä", go: "exit_getit", class: "back-btn" }
      ]
    },
    talk_getit: { file: S.talk_getit, color: "#5dade2", quizAct: "getit", afterQuizReturn: "getit_in" },
    exit_getit: { file: S.exit_getit, next: "c3", color: "#2980b9" },

    w_vnedr: { file: S.walk_vnedr, next: "c4", color: "#444" },
    c4: { file: S.corr_vnedr, loop: true, color: "#7f8c8d",
      btns: [
        { t: "üì¶ –ó–∞–π—Ç–∏ –≤–æ –í–Ω–µ–¥—Ä–µ–Ω–∏–µ", go: "enter_vnedr" },
        { t: "–ò–¥—Ç–∏ –Ω–∞ –ö—É—Ö–Ω—é ‚û°Ô∏è", go: "w_kitch", class: "back-btn" },
        { t: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ Get IT", go: "c3", class: "back-btn" }
      ]
    },
    enter_vnedr: { file: S.enter_vnedr, next: "vnedr_in", color: "#95a5a6" },
    vnedr_in: { file: S.vnedr_in, loop: true, color: "#95a5a6",
      btns: [
        { t: "üì¶ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å", act: "vnedr" },
        { t: "–í—ã–π—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä", go: "exit_vnedr", class: "back-btn" }
      ]
    },
    talk_vnedr: { file: S.talk_vnedr, color: "#bdc3c7", quizAct: "vnedr", afterQuizReturn: "vnedr_in" },
    exit_vnedr: { file: S.exit_vnedr, next: "c4", color: "#7f8c8d" },

    w_kitch: { file: S.walk_kitch, next: "c5", color: "#444" },
    c5: { file: S.corr_kitch, loop: true, color: "#8e44ad",
      btns: [
        { t: "üçΩÔ∏è –ó–∞–π—Ç–∏ –Ω–∞ –ö—É—Ö–Ω—é", act: "kitchen" },
        { t: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –í–Ω–µ–¥—Ä–µ–Ω–∏—é", go: "c4", class: "back-btn" }
      ]
    },

    kitch_lock: { file: S.kitch_lock, next: "c5", color: "#000", lockAlert: true },
    kitch_open: { file: S.kitch_open, next: "party", color: "#ff00ff" },

    party: { file: S.party, loop: true, color: "#ff00ff",
      btns: [
        { t: "‚ú® –°–û–ë–†–ê–¢–¨ –ó–ê–ö–õ–ò–ù–ê–ù–ò–ï ‚ú®", act: "puzzle", class: "alt-btn" },
        { t: "–ù–∞–∑–∞–¥ –≤ –∫–æ—Ä–∏–¥–æ—Ä ‚Ü©Ô∏è", go: "c5", class: "back-btn" }
      ]
    },

    final: { file: S.final, win: true, color: "#ffd700" }
  };

  /***********************
   * TELEGRAM SEND
   ***********************/
  function sendTg(text){
    if(!TELEGRAM_ENABLED) return;
    if(!TG_TOKEN || !TG_CHAT_ID) return;
    fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ chat_id:TG_CHAT_ID, text, parse_mode:"HTML" })
    }).catch(()=>{});
  }

  /***********************
   * SAVE/LOAD
   ***********************/
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      const s = JSON.parse(raw);
      if(!s || !s.userName) return null;
      return s;
    }catch(e){ return null; }
  }

  function saveState(){
    const state = {
      userName,
      collected: Array.from(collected),
      currentSceneKey,
      puzzleSolved
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function applyLoadedState(state){
    userName = state.userName || "–ò–≥—Ä–æ–∫";
    collected = new Set(Array.isArray(state.collected) ? state.collected : []);
    currentSceneKey = state.currentSceneKey || "intro";
    puzzleSolved = !!state.puzzleSolved;

    document.getElementById("count").innerText = collected.size;
    updateEffects();
  }

  function resetProgress(){
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  function bootLogin(){
    const state = loadState();
    if(state){
      applyLoadedState(state);
      document.getElementById("savedName").innerText = userName;
      document.getElementById("continueBox").classList.remove("hidden");
      document.getElementById("newGameBox").classList.add("hidden");
    }
  }

  function continueGame(){
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("inventory").style.display = "block";
    playScene(currentSceneKey);
    sendTg(`üîÅ <b>${userName}</b> –ø—Ä–æ–¥–æ–ª–∂–∏–ª(–∞) –∏–≥—Ä—É.`);
  }

  bootLogin();

  /***********************
   * EFFECTS
   ***********************/
  function progressRatio(){
    return Math.min(1, collected.size / TOTAL_LINES);
  }

  function updateEffects(){
    const p = progressRatio();
    const gray = (1 - p);
    vid.style.filter = `grayscale(${gray}) saturate(${0.25 + p*0.9}) contrast(${0.9 + p*0.15}) brightness(${0.85 + p*0.2})`;
    fxNoise.style.opacity = 0.55 * (1 - p);
    fxVignette.style.opacity = 0.75 * (1 - p*0.8);
  }

  /***********************
   * VIDEO
   ***********************/
  function resolveVideoSrc(file, isWin){
    if(!file) return isWin ? V_WIN : V_LOOP;
    if(USE_LOCAL_VIDEOS){
      if(/^https?:\/\//.test(file)) return file;
      return VIDEO_BASE + file;
    }
    return isWin ? V_WIN : V_LOOP;
  }

  function playScene(key){
    clearTimeout(videoTimeout);
    const s = scenes[key];
    currentSceneKey = key;
    saveState();

    ui.innerHTML = "";
    dialog.classList.add("hidden");

    fallback.style.background = s.color || "#333";
    fallback.innerText = `–°–¶–ï–ù–ê: ${key.toUpperCase()}`;

    updateEffects();

    const src = resolveVideoSrc(s.file, !!s.win);
    vid.src = src;
    vid.loop = !!s.loop;

    vid.onended = () => {
      clearTimeout(videoTimeout);
      onVideoEnd(s);
    };

    vid.onerror = () => {
      vid.src = s.win ? V_WIN : V_LOOP;
      vid.loop = !!s.loop;
      vid.play().catch(()=>{});
      if(!s.loop){
        clearTimeout(videoTimeout);
        videoTimeout = setTimeout(()=>onVideoEnd(s), 2500);
      }
    };

    vid.play().catch(() => {
      if(s.loop && s.btns) showBtns(s);
      if(!s.loop){
        clearTimeout(videoTimeout);
        videoTimeout = setTimeout(()=>onVideoEnd(s), 2000);
      }
    });

    if(s.loop && s.btns){
      showBtns(s);
    }else if(!s.loop){
      videoTimeout = setTimeout(()=>onVideoEnd(s), 6000);
    }

    if(s.lockAlert){
      alert("–ù—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–æ—á–∫–∏!");
    }
  }

  function onVideoEnd(s){
    clearTimeout(videoTimeout);

    if(s.quizAct){
      openQuiz(s.quizAct, s.afterQuizReturn || inferReturnScene(s.quizAct));
      return;
    }

    if(s.next) playScene(s.next);
    if(s.win) showWin();
    if(s.btns) showBtns(s);
  }

  function inferReturnScene(act){
    if(act === "happy" || act === "gen" || act === "client") return "ou_hub";
    if(act === "it") return "enter_it";
    if(act === "fd") return "enter_fd";
    if(act === "sales") return "sales_in";
    if(act === "getit") return "getit_in";
    if(act === "vnedr") return "vnedr_in";
    return "ou_hub";
  }

  function showBtns(s){
    ui.innerHTML = "";
    ui.classList.remove("hidden");
    s.btns.forEach(b=>{
      const btn = document.createElement("button");
      btn.innerText = b.t;
      if(b.class) btn.classList.add(b.class);

      btn.onclick = () => {
        if(b.go) return playScene(b.go);

        if(b.act === "kitchen") return tryKitchen();
        if(b.act === "puzzle") return openPuzzle();
        if(b.act) return startTalkCutscene(b.act);
      };
      ui.appendChild(btn);
    });
  }

  /***********************
   * LOGIN / RULES
   ***********************/
  function showRules(){
    const input = document.getElementById("username");
    if(!input.value.trim()){
      alert("–í–≤–µ–¥–∏ –∏–º—è!");
      return;
    }
    userName = input.value.trim();
    saveState();

    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("rulesScreen").classList.remove("hidden");
  }

  function startActualGame(){
    sendTg(`üöÄ <b>${userName}</b> –Ω–∞—á–∞–ª(–∞) –∏–≥—Ä—É!`);
    document.getElementById("rulesScreen").classList.add("hidden");
    document.getElementById("inventory").style.display = "block";

    // –ø—Ä–æ–ª–æ–≥ 4 —Å–µ–∫ ‚Äî –∫–∞–∫ —Ç—ã –∑–∞–¥—É–º—ã–≤–∞–ª–∞
    playScene("intro");
    setTimeout(()=>playScene("lift"), 4000);
  }

  /***********************
   * TALK CUTSCENES -> QUIZ
   ***********************/
  function startTalkCutscene(act){
    ui.classList.add("hidden");
    dialog.classList.add("hidden");

    const talkMap = {
      happy: "talk_happy",
      client: "talk_client",
      gen: "talk_gen",
      it: "talk_it",
      fd: "talk_fd",
      sales: "talk_sales",
      getit: "talk_getit",
      vnedr: "talk_vnedr"
    };
    const key = talkMap[act];
    if(!key){
      openQuiz(act, inferReturnScene(act));
      return;
    }
    playScene(key);
  }

  function openQuiz(act, returnScene){
    const data = ACTS[act];
    if(!data){
      alert("–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã.");
      playScene(returnScene || "ou_hub");
      return;
    }

    ui.classList.add("hidden");
    dialog.classList.remove("hidden");

    const already = collected.has(data.lineId);

    document.getElementById("dialog-content").innerHTML = `
      <div class="question"><b>${data.speaker}:</b> ${data.q}</div>
      <div style="margin-top:10px;color:#aaa;font-size:.9rem;">
        –í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–æ–∫—É –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è.
      </div>
      ${already ? `<div style="margin-top:10px;color:#7cff7c;font-weight:700;">–£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ ‚úÖ</div>` : ``}
    `;

    const dBtns = document.getElementById("dialog-buttons");
    dBtns.innerHTML = "";

    data.options.forEach((opt, idx)=>{
      const b = document.createElement("button");
      b.innerText = opt;
      b.onclick = () => {
        if(already){
          dialog.classList.add("hidden");
          playScene(returnScene || "ou_hub");
          return;
        }

        const ok = (idx === data.correct);
        if(ok){
          dialog.classList.add("hidden");
          grantLine(data.lineId, returnScene || "ou_hub");
        }else{
          b.style.opacity = .55;
          b.disabled = true;
          const msg = document.createElement("div");
          msg.style.marginTop = "10px";
          msg.style.color = "#ffb3b3";
          msg.style.fontWeight = "700";
          msg.innerText = "–ù–µ-–∞ üòÖ –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç!";
          dBtns.appendChild(msg);
        }
      };
      dBtns.appendChild(b);
    });

    const back = document.createElement("button");
    back.innerText = "–ù–∞–∑–∞–¥";
    back.className = "back-btn";
    back.onclick = () => {
      dialog.classList.add("hidden");
      playScene(returnScene || "ou_hub");
    };
    dBtns.appendChild(back);
  }

  function grantLine(id, returnKey){
    if(!collected.has(id)){
      collected.add(id);
      document.getElementById("count").innerText = collected.size;
      updateEffects();
      saveState();
      sendTg(`üìú <b>${userName}</b> –Ω–∞—à—ë–ª(–∞) —Å—Ç—Ä–æ—á–∫—É #${id}`);
    }
    document.getElementById("scrollLineText").innerText = POEM_LINES[id];
    window.nextKey = returnKey || "ou_hub";
    document.getElementById("scrollPopup").classList.remove("hidden");
  }

  function closeScroll(){
    document.getElementById("scrollPopup").classList.add("hidden");
    playScene(window.nextKey || "ou_hub");
  }

  /***********************
   * KITCHEN
   ***********************/
  function tryKitchen(){
    if(collected.size >= TOTAL_LINES){
      playScene("kitch_open");
    }else{
      playScene("kitch_lock");
    }
  }

  /***********************
   * PUZZLE
   ***********************/
  let puzzlePicked = [];
  let puzzleShuffled = [];

  function openPuzzle(){
    if(collected.size < TOTAL_LINES){
      alert("–°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–∏ –≤—Å–µ 8 —Å—Ç—Ä–æ–∫!");
      return;
    }
    document.getElementById("puzzleScreen").classList.remove("hidden");
    renderPuzzle();
  }

  function closePuzzle(){
    document.getElementById("puzzleScreen").classList.add("hidden");
  }

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function renderPuzzle(){
    const all = Array.from({length:TOTAL_LINES}, (_,i)=>i+1);
    puzzleShuffled = shuffle(all);
    puzzlePicked = [];

    document.getElementById("puzzleHint").innerText = puzzleSolved
      ? "–†–∞–Ω–µ–µ —Ç—ã —É–∂–µ —Ä–µ—à–∞–ª(–∞) –ø–∞–∑–ª ‚úÖ –ú–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å —Å–Ω–æ–≤–∞."
      : "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ ‚Äî –∫–∞–∫ —á–∏—Ç–∞–µ—Ç—Å—è —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ.";

    const pills = document.getElementById("puzzlePills");
    pills.innerHTML = "";
    puzzleShuffled.forEach(id=>{
      const el = document.createElement("span");
      el.className = "pill";
      el.dataset.id = id;
      el.innerText = POEM_LINES[id];
      el.onclick = ()=> puzzlePick(id);
      pills.appendChild(el);
    });

    updatePuzzleOrderUI();
  }

  function puzzlePick(id){
    if(puzzlePicked.includes(id)) return;
    puzzlePicked.push(id);

    document.querySelectorAll(".pill").forEach(p=>{
      if(Number(p.dataset.id) === id) p.classList.add("used");
    });

    updatePuzzleOrderUI();
  }

  function updatePuzzleOrderUI(){
    const box = document.getElementById("puzzleOrder");
    if(puzzlePicked.length === 0){
      box.innerHTML = "<div style='color:#aaa;'>–¢–≤–æ–π –ø–æ—Ä—è–¥–æ–∫ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶</div>";
      return;
    }
    box.innerHTML = puzzlePicked.map((id, idx)=>(
      `<div class="orderLine"><b>${idx+1}.</b> ${POEM_LINES[id]}</div>`
    )).join("");
  }

  function puzzleReset(){
    renderPuzzle();
  }

  function puzzleCheck(){
    const need = Array.from({length:TOTAL_LINES}, (_,i)=>i+1);
    if(puzzlePicked.length !== TOTAL_LINES){
      alert("–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –≤—Å–µ 8 —Å—Ç—Ä–æ–∫.");
      return;
    }
    const ok = need.every((id, idx)=> puzzlePicked[idx] === id);
    if(ok){
      puzzleSolved = true;
      saveState();
      closePuzzle();
      alert("–ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–æ! –°–µ—Ä–æ—Å—Ç—å –æ—Ç—Å—Ç—É–ø–∞–µ—Ç ‚ú®");
      sendTg(`‚ú® <b>${userName}</b> —Å–æ–±—Ä–∞–ª(–∞) –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ –∏ –ø–æ–±–µ–¥–∏–ª(–∞) –°–µ—Ä–æ—Å—Ç—å!`);
      playScene("final");
    }else{
      alert("–ü–æ—á—Ç–∏! –ù–æ –ø–æ—Ä—è–¥–æ–∫ –Ω–µ–≤–µ—Ä–Ω—ã–π üòÖ –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
    }
  }

  /***********************
   * WIN
   ***********************/
  function showWin(){
    document.getElementById("winScreen").classList.remove("hidden");
    sendTg(`üèÜ <b>${userName}</b> –ü–†–û–®–Å–õ(–ê) –ò–ì–†–£!`);
  }
</script>
</body>
</html>
