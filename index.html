<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QUEST TEST: –õ—É–Ω–∞ –ø—Ä–æ—Ç–∏–≤ –°–µ—Ä–æ—Å—Ç–∏</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
        
        body { margin: 0; background: #000; color: #fff; font-family: 'Montserrat', sans-serif; overflow: hidden; height: 100vh; }
        #game-container { position: relative; width: 100%; height: 100%; max-width: 500px; margin: 0 auto; background: #111; }
        
        /* –í–∏–¥–µ–æ */
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; background: #000; }
        
        /* –ó–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –≤–∏–¥–µ–æ —Å–ª–æ–º–∞–ª–æ—Å—å */
        #fallback-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; box-sizing: border-box; background: #222; color: #555; font-size: 1.5rem; font-weight: bold; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; box-sizing: border-box; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent 50%); pointer-events: none; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        button { pointer-events: auto; background: rgba(255, 215, 0, 0.95); color: #000; border: 2px solid #fff; padding: 15px; margin: 5px 0; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; text-transform: uppercase; animation: popIn 0.3s; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); width: 100%; }
        button:active { transform: scale(0.98); }
        button.secondary { background: rgba(255, 255, 255, 0.2); color: #fff; border: 1px solid rgba(255,255,255,0.5); }

        /* –î–∏–∞–ª–æ–≥–∏ */
        .dialog-box { position: absolute; bottom: 20px; left: 20px; right: 20px; background: rgba(0,0,0,0.9); border: 2px solid #ffd700; border-radius: 15px; padding: 20px; z-index: 20; text-align: center; pointer-events: auto; }
        .dialog-text { font-size: 1.1rem; margin-bottom: 20px; color: #fff; }
        
        /* –°–≤–∏—Ç–æ–∫ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        .scroll-popup { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; animation: fadeIn 0.5s; }
        .scroll-content { background: #fff5e6; color: #333; padding: 30px; border-radius: 5px; max-width: 80%; text-align: center; box-shadow: 0 0 50px #ffd700; transform: scale(0); animation: scaleIn 0.5s forwards; border: 4px double #8b4513; }
        .scroll-text { font-family: 'Georgia', serif; font-style: italic; font-size: 1.2rem; margin: 20px 0; font-weight: bold; }
        
        /* –≠–∫—Ä–∞–Ω—ã –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 30px; box-sizing: border-box; }
        .hidden { display: none !important; }
        input { padding: 15px; border-radius: 10px; border: 2px solid #ffd700; background: #222; color: #fff; font-size: 1.1rem; margin-bottom: 20px; width: 100%; box-sizing: border-box; text-align: center; }
        
        /* –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å */
        #inventory { position: absolute; top: 20px; right: 20px; z-index: 15; background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; border: 1px solid #ffd700; font-weight: bold; color: #ffd700; display: none; }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0) rotate(-10deg); } to { transform: scale(1) rotate(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="game-container">
    <div id="fallback-screen">–ó–ê–ì–†–£–ó–ö–ê...</div>
    
    <video id="vid" playsinline webkit-playsinline muted></video>
    
    <div id="inventory">üìú <span id="count">0</span>/8</div>
    
    <div id="ui" class="ui-layer hidden"></div>

    <div id="dialog" class="dialog-box hidden">
        <div id="dialog-text" class="dialog-text"></div>
        <div id="dialog-buttons"></div>
    </div>

    <div id="scrollPopup" class="scroll-popup hidden">
        <div class="scroll-content">
            <h3>‚ú® –í–´ –ù–ê–®–õ–ò –°–¢–†–û–ß–ö–£! ‚ú®</h3>
            <p class="scroll-text" id="scrollLineText">...</p>
            <button onclick="closeScroll()">–£–ë–†–ê–¢–¨ –í –ò–ù–í–ï–ù–¢–ê–†–¨</button>
        </div>
    </div>

    <div id="loginScreen" class="overlay">
        <h1 style="color:#ffd700">–¢–ï–°–¢: –õ–£–ù–ê v –°–ï–†–û–°–¢–¨</h1>
        <p>–í–µ—Ä—Å–∏—è 2.0 (Safe Mode)<br>–ï—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –≥—Ä—É–∑–∏—Ç - –±—É–¥–µ—Ç —Ü–≤–µ—Ç–Ω–æ–π —Ñ–æ–Ω.</p>
        <input type="text" id="username" placeholder="–í–≤–µ–¥–∏ –∏–º—è">
        <button onclick="startGame()">–ù–ê–ß–ê–¢–¨ –¢–ï–°–¢</button>
    </div>

    <div id="winScreen" class="overlay hidden">
        <h1 style="color:#ffd700">–ü–û–ë–ï–î–ê!</h1>
        <p>–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!<br>–ú–µ—Ö–∞–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç.</p>
        <button onclick="location.reload()">–í –ú–ï–ù–Æ</button>
    </div>
</div>

<script>
    const TG_TOKEN = "8287827338:AAEaIEkNbJuk_6oFR5lEmLCQ0nObVKvpmsg"; 
    const TG_CHAT_ID = "7524680591";

    const vid = document.getElementById('vid');
    const fallback = document.getElementById('fallback-screen');
    const ui = document.getElementById('ui');
    const dialog = document.getElementById('dialog');
    let collected = new Set();
    let userName = "–¢–µ—Å—Ç–µ—Ä";

    const POEM_LINES = {
        1: "–ó–∞–∂–∂—ë–º —Å–µ—Ä–¥—Ü–∞, –ø—Ä–æ–≥–æ–Ω–∏–º –ø—Ä–æ—á—å —Ç–æ—Å–∫—É,",
        2: "–ö–ª–∏–µ–Ω—Ç –¥–æ–≤–æ–ª–µ–Ω ‚Äî –º—ã –≤—Å–µ–≥–¥–∞ –Ω–∞ —á–µ–∫—É!",
        3: "–°–≤–µ–¥—ë–º –±–∞–ª–∞–Ω—Å: –∫–æ–ø–µ–π–∫–∞ –¥–æ —Ä—É–±–ª—è,",
        4: "–ò –Ω–µ –∑–∞–≤–∏—Å–Ω–µ—Ç —Å–µ—Ä–≤–µ—Ä –Ω–∏–∫–æ–≥–¥–∞!",
        5: "–°—Ç—Ä–∞—Ç–µ–≥–∏—è —è—Å–Ω–∞, –±—é–¥–∂–µ—Ç —Ä–∞—Å—Ç—ë—Ç,",
        6: "–ü–æ–±—å—ë–º —Ä–µ–∫–æ—Ä–¥—ã –≤ —ç—Ç–æ—Ç –ù–æ–≤—ã–π –≥–æ–¥!",
        7: "–°–∏—Å—Ç–µ–º–∞ ‚Äî –≤ –Ω–æ—Ä–º–µ, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ ‚Äî –∏–¥–µ–∞–ª,",
        8: "–ß—Ç–æ–± —á–∏—Å—Ç—ã–π –∫–æ–¥ –ø–æ–±–µ–¥—É –Ω–∞–º –∫–æ–≤–∞–ª!"
    };

    // –ù–ê–î–ï–ñ–ù–´–ï –¢–ï–°–¢–û–í–´–ï –í–ò–î–ï–û (Chrome friendly)
    const V_LOOP = "https://media.istockphoto.com/id/1363653139/video/abstract-background.mp4?s=mp4-640x640-is&k=20&c=6a_aQjQGkY3XFjF9p0yqQ1qXqQ4Q4Q4Q4Q4Q4Q4Q4Q="; // –ü—Ä–æ—Å—Ç–æ —Ñ–æ–Ω
    const V_WIN = "https://media.istockphoto.com/id/1183318283/video/fireworks.mp4?s=mp4-640x640-is&k=20&c=6a_aQjQGkY3XFjF9p0yqQ1qXqQ4Q4Q4Q4Q4Q4Q4Q4Q=";

    // –¶–≤–µ—Ç–∞ –¥–ª—è —Ñ–æ–ª–±—ç–∫–∞, –µ—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    const COLORS = {
        'intro': '#333',
        'corridor': '#2c3e50',
        'ou_hub': '#c0392b',
        'it': '#27ae60',
        'sales': '#f39c12'
    };

    const scenes = {
        'intro': { file: V_LOOP, loop: true, color: '#111' },
        'start_walk': { file: V_LOOP, next: 'corridor', color: '#444' },
        'corridor': { 
            file: V_LOOP, loop: true, color: '#2c3e50',
            btns: [
                {t: 'üìÇ –û—Ç–¥–µ–ª –£—á–µ—Ç–∞', go: 'enter_ou'},
                {t: 'üìà –ü—Ä–æ–¥–∞–∂–∏', go: 'enter_sales'},
                {t: 'üì¶ –í–Ω–µ–¥—Ä–µ–Ω–∏–µ', go: 'enter_vnedr'},
                {t: 'üíª Get IT', go: 'enter_getit'},
                {t: 'üçΩÔ∏è –ö—É—Ö–Ω—è (–§–∏–Ω–∞–ª)', act: 'try_kitchen'}
            ]
        },
        'enter_ou': { file: V_LOOP, next: 'ou_hub', color: '#c0392b' },
        'ou_hub': {
            file: V_LOOP, loop: true, color: '#c0392b',
            btns: [
                {t: '‚ú® –ü–æ–¥–æ–π—Ç–∏ –∫ "–°—á–∞—Å—Ç—å—é"', act: 'talk_happy'},
                {t: 'ü§ù –ü–æ–¥–æ–π—Ç–∏ –∫ –ö–ª–∏–µ–Ω—Ç—Å–∫–æ–º—É', act: 'talk_client'},
                {t: 'üìë –ü–æ–¥–æ–π—Ç–∏ –∫ –û–±—â–µ–º—É', act: 'talk_general'},
                {t: 'üö™ –ó–∞–π—Ç–∏ –≤ IT', go: 'enter_it'},
                {t: 'üíº –ó–∞–π—Ç–∏ –∫ –§–∏–Ω–î–∏—Ä—É', go: 'enter_findir'},
                {t: 'üîô –í –∫–æ—Ä–∏–¥–æ—Ä', go: 'exit_ou'}
            ]
        },
        'exit_ou': { file: V_LOOP, next: 'corridor', color: '#444' },

        'talk_happy': { vid: V_LOOP, id: 1, color: '#e74c3c' },
        'talk_client': { vid: V_LOOP, id: 2, color: '#e74c3c' },
        'talk_general': { vid: V_LOOP, id: 3, color: '#e74c3c' },

        'enter_it': { file: V_LOOP, loop: false, nextButtons: [{t: 'üíª –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å IT', act: 'talk_it'}], color: '#27ae60' },
        'talk_it': { vid: V_LOOP, id: 4, exit: 'exit_it', color: '#2ecc71' },
        'exit_it': { file: V_LOOP, next: 'ou_hub', color: '#27ae60' },

        'enter_findir': { file: V_LOOP, loop: false, nextButtons: [{t: 'üíº –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –§–∏–Ω–î–∏—Ä–æ–º', act: 'talk_findir'}], color: '#8e44ad' },
        'talk_findir': { vid: V_LOOP, id: 5, exit: 'exit_findir', color: '#9b59b6' },
        'exit_findir': { file: V_LOOP, next: 'ou_hub', color: '#8e44ad' },

        'enter_sales': { file: V_LOOP, nextButtons: [{t: 'üó£ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å', act: 'talk_sales'}], color: '#f39c12' },
        'talk_sales': { vid: V_LOOP, id: 6, exit: 'exit_sales', color: '#f1c40f' },
        'exit_sales': { file: V_LOOP, next: 'corridor', color: '#f39c12' },

        'enter_vnedr': { file: V_LOOP, nextButtons: [{t: 'üì¶ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å', act: 'talk_vnedr'}], color: '#7f8c8d' },
        'talk_vnedr': { vid: V_LOOP, id: 7, exit: 'exit_vnedr', color: '#bdc3c7' },
        'exit_vnedr': { file: V_LOOP, next: 'corridor', color: '#7f8c8d' },

        'enter_getit': { file: V_LOOP, nextButtons: [{t: 'üë®‚Äçüíª –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å', act: 'talk_getit'}], color: '#2980b9' },
        'talk_getit': { vid: V_LOOP, id: 8, exit: 'exit_getit', color: '#3498db' },
        'exit_getit': { file: V_LOOP, next: 'corridor', color: '#2980b9' },

        'kitchen_locked': { file: V_LOOP, nextButtons: [{t: '–ù—É–∂–Ω–æ 8 —Å—Ç—Ä–æ—á–µ–∫!', go: 'corridor'}], color: '#000' },
        'kitchen_enter': { file: V_WIN, next: 'kitchen_party', color: '#ff00ff' },
        'kitchen_party': { file: V_WIN, loop: true, btns: [{t: '‚ú® –ó–ê–ö–õ–ò–ù–ê–ù–ò–ï ‚ú®', go: 'final_spell'}], color: '#ff00ff' },
        'final_spell': { file: V_WIN, win: true, color: '#ffd700' }
    };

    function startGame() {
        const input = document.getElementById('username');
        if (!input.value) { alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!"); return; }
        userName = input.value;
        sendTg(`üöÄ <b>${userName}</b> –Ω–∞—á–∞–ª(–∞) –¢–ï–°–¢ –∏–≥—Ä—É!`);
        
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('inventory').style.display = 'block';
        playScene('intro');
        // –ß–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É "–∑–∞—Ö–æ–¥–∏–º"
        setTimeout(() => playScene('start_walk'), 1000); 
    }

    function playScene(sceneName) {
        const scene = scenes[sceneName];
        ui.innerHTML = '';
        dialog.classList.add('hidden');

        // 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–ª–±—ç–∫ —Ü–≤–µ—Ç (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –≥—Ä—É–∑–∏—Ç)
        fallback.style.background = scene.color || '#333';
        fallback.innerText = "–°–¶–ï–ù–ê: " + sceneName.toUpperCase() + "\n(–ï—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ—Ç - —ç—Ç–æ –∑–∞–≥–ª—É—à–∫–∞)";
        
        // 2. –ü—Ä–æ–±—É–µ–º –≤–∏–¥–µ–æ
        vid.src = scene.file || V_LOOP;
        vid.loop = scene.loop || false;
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∏–¥–µ–æ
        vid.onerror = () => {
            console.log("–í–∏–¥–µ–æ –Ω–µ –≥—Ä—É–∑–∏—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç–Ω–æ–π —Ñ–æ–Ω");
            // –ï—Å–ª–∏ –≤–∏–¥–µ–æ —Å–ª–æ–º–∞–ª–æ—Å—å, —ç–º—É–ª–∏—Ä—É–µ–º –µ–≥–æ –æ–∫–æ–Ω—á–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —Ç–∞–π–º–µ—Ä (—á—Ç–æ–±—ã –∏–≥—Ä–∞ –Ω–µ –≤–∏—Å–ª–∞)
            if (!scene.loop) setTimeout(onVideoEnd, 2000);
            else showButtons(scene);
        };

        const playPromise = vid.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.log("–ê–≤—Ç–æ–ø–ª–µ–π –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞:", error);
                // –¢–æ–∂–µ —ç–º—É–ª–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É
                if (!scene.loop) setTimeout(onVideoEnd, 2000);
                else showButtons(scene);
            });
        }

        vid.onended = onVideoEnd;

        function onVideoEnd() {
            if (scene.next) playScene(scene.next);
            if (scene.win) showWin();
            if (scene.btns || scene.nextButtons) showButtons(scene);
        }

        function showButtons(s) {
            const bList = s.btns || s.nextButtons;
            if (bList) showUI(bList);
        }
    }

    function showUI(buttons) {
        ui.innerHTML = '';
        ui.classList.remove('hidden');
        buttons.forEach(b => {
            const btn = document.createElement('button');
            btn.innerText = b.t;
            btn.onclick = () => {
                if (b.go) playScene(b.go);
                if (b.act === 'try_kitchen') tryKitchen();
                if (b.act && b.act.startsWith('talk')) startDialog(b.act);
            };
            ui.appendChild(btn);
        });
    }

    function startDialog(actionKey) {
        const data = scenes[actionKey]; 
        ui.classList.add('hidden'); 
        
        dialog.classList.remove('hidden');
        const dialogText = document.getElementById('dialog-text');
        const dialogBtns = document.getElementById('dialog-buttons');
        
        dialogText.innerText = "–°–æ–±–∏—Ä–∞–µ–º –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ. –ï—Å—Ç—å —Å—Ç—Ä–æ—á–∫–∞?";
        dialogBtns.innerHTML = '';

        const btnYes = document.createElement('button');
        btnYes.innerText = "–î–∞! (–í–∑—è—Ç—å)";
        
        if (collected.has(data.id)) {
            btnYes.innerText = "–£–∂–µ –µ—Å—Ç—å!";
            btnYes.classList.add('secondary');
            btnYes.disabled = true;
        } else {
            btnYes.onclick = () => playItemVideo(data);
        }

        const btnNo = document.createElement('button');
        btnNo.innerText = "–£–π—Ç–∏";
        btnNo.classList.add('secondary');
        btnNo.onclick = () => {
            dialog.classList.add('hidden');
            if (data.exit) playScene(data.exit); 
            else playScene('ou_hub');
        };

        dialogBtns.appendChild(btnYes);
        dialogBtns.appendChild(btnNo);
    }

    function playItemVideo(data) {
        dialog.classList.add('hidden');
        // –¢—É—Ç —Ç–æ–∂–µ –º–µ–Ω—è–µ–º —Ñ–æ–Ω –Ω–∞ —Ü–≤–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        fallback.style.background = data.color || '#555';
        fallback.innerText = "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –≥–æ–≤–æ—Ä–∏—Ç...";
        
        vid.src = data.vid || V_LOOP;
        vid.play().catch(() => setTimeout(() => showScrollPopup(data.id, data.exit || 'ou_hub'), 1500));
        
        vid.onended = () => {
            showScrollPopup(data.id, data.exit || 'ou_hub');
        };
    }

    function showScrollPopup(id, exitScene) {
        const popup = document.getElementById('scrollPopup');
        const text = document.getElementById('scrollLineText');
        text.innerText = POEM_LINES[id];
        popup.classList.remove('hidden');
        window.currentExit = exitScene;
        
        if (!collected.has(id)) {
            collected.add(id);
            document.getElementById('count').innerText = collected.size;
            sendTg(`üìú ${userName} –Ω–∞—à–µ–ª —Å—Ç—Ä–æ—á–∫—É #${id} (${collected.size}/8)`);
        }
    }

    function closeScroll() {
        document.getElementById('scrollPopup').classList.add('hidden');
        playScene(window.currentExit);
    }

    function tryKitchen() {
        if (collected.size >= 8) playScene('kitchen_enter');
        else playScene('kitchen_locked');
    }

    function showWin() {
        document.getElementById('winScreen').classList.remove('hidden');
        sendTg(`üèÜ <b>${userName} –ü–†–û–®–ï–õ –¢–ï–°–¢ –ò–ì–†–£!</b>`);
    }

    function sendTg(text) {
        fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({chat_id: TG_CHAT_ID, text: text, parse_mode: 'HTML'})
        }).catch(err => console.log(err));
    }

</script>
</body>
</html>
